const { useState, useEffect, useCallback, useMemo, useRef } = React;
const { LineChart, Line, BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid, Cell, PieChart, Pie } = Recharts;

const calc = {
  amerToDec: a => a > 0 ? a/100+1 : 100/Math.abs(a)+1,
  decToAmer: d => d >= 2 ? Math.round((d-1)*100) : Math.round(-100/(d-1)),
  toWin: (s, d) => Math.round(s*(d-1)*100)/100,
  stake: (tw, d) => Math.round((tw/(d-1))*100)/100,
  netProfit: (r, s, tw, co) => ({win:tw,loss:-s,push:0,void:0,half_win:Math.round(tw/2*100)/100,half_loss:-Math.round(s/2*100)/100,cashout:(co||0)-s}[r]??0),
  parlayOdds: legs => legs.reduce((a,l) => a*(l.oddsDec||1),1),
  avgDecOdds: entries => { const v=entries.filter(e=>e.oddsDec>0); if(!v.length) return null; const ts=v.reduce((s,e)=>s+(e.stake||0),0); return ts<=0?v.reduce((s,e)=>s+e.oddsDec,0)/v.length:v.reduce((s,e)=>s+e.oddsDec*(e.stake||0),0)/ts; },
};
const uid = () => Date.now().toString(36)+Math.random().toString(36).slice(2,8);
const fmt = (n,d=2) => n!=null?Number(n).toFixed(d):"â€”";
const fmtUsd = n => n!=null?(n>=0?"+$":"-$")+Math.abs(n).toFixed(2):"â€”";
const fmtOdds = a => a!=null?(a>0?"+"+a:""+a):"â€”";
const dayKey = d => new Date(d).toISOString().slice(0,10);
const DOT = " Â· ";
function nowET(){try{const d=new Date(),p=new Intl.DateTimeFormat("en-CA",{timeZone:"America/New_York",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:false}).formatToParts(d),g=t=>(p.find(x=>x.type===t)||{}).value||"";return g("year")+"-"+g("month")+"-"+g("day")+"T"+g("hour")+":"+g("minute");}catch(e){return new Date().toISOString().slice(0,16);}}
function guessSeasonSport(){const m=new Date().getMonth();if(m>=2&&m<=4)return"Basketball";return"Football";}

function buildDisplay(mt,team,line,ou,participant,propStat,matchP1,matchP2,matchSide){
  const ln=line!==""&&line!=null?parseFloat(line):null;const ls=ln!=null?(ln>0?"+"+ln:""+ln):"";
  switch(mt){
    case"Moneyline":case"1H ML":case"1Q ML":case"1P ML":return(team||"?")+" ML";
    case"Spread":case"1H Spread":case"1Q Spread":case"Alt Spread":case"1P Spread":return(team||"?")+" "+ls;
    case"Total":case"1H Total":case"1Q Total":case"Alt Total":case"1P Total":case"Set Total":case"Round Total":return(ou||"Over")+" "+(ln!=null?ln:"?");
    case"Team Total":return(team||"?")+" TT "+(ou||"O")+" "+(ln!=null?ln:"?");
    case"Player Prop":return(participant||"?")+" "+(ou||"O")+" "+(ln!=null?ln:"?")+(propStat?" "+propStat:"");
    case"Top 5":case"Top 10":case"Top 20":case"Outright Winner":return(participant||team||"?")+" "+mt;
    case"Matchup":return matchP1&&matchP2?(matchSide==="p2"?matchP2:matchP1)+" over "+(matchSide==="p2"?matchP1:matchP2):(team||"?");
    default:return team||"?";
  }
}

// ---- TEAM/PLAYER DATA ----
const T_NFL="Arizona Cardinals,Atlanta Falcons,Baltimore Ravens,Buffalo Bills,Carolina Panthers,Chicago Bears,Cincinnati Bengals,Cleveland Browns,Dallas Cowboys,Denver Broncos,Detroit Lions,Green Bay Packers,Houston Texans,Indianapolis Colts,Jacksonville Jaguars,Kansas City Chiefs,Las Vegas Raiders,Los Angeles Chargers,Los Angeles Rams,Miami Dolphins,Minnesota Vikings,New England Patriots,New Orleans Saints,New York Giants,New York Jets,Philadelphia Eagles,Pittsburgh Steelers,San Francisco 49ers,Seattle Seahawks,Tampa Bay Buccaneers,Tennessee Titans,Washington Commanders".split(",");
const T_NBA="Atlanta Hawks,Boston Celtics,Brooklyn Nets,Charlotte Hornets,Chicago Bulls,Cleveland Cavaliers,Dallas Mavericks,Denver Nuggets,Detroit Pistons,Golden State Warriors,Houston Rockets,Indiana Pacers,Los Angeles Clippers,Los Angeles Lakers,Memphis Grizzlies,Miami Heat,Milwaukee Bucks,Minnesota Timberwolves,New Orleans Pelicans,New York Knicks,Oklahoma City Thunder,Orlando Magic,Philadelphia 76ers,Phoenix Suns,Portland Trail Blazers,Sacramento Kings,San Antonio Spurs,Toronto Raptors,Utah Jazz,Washington Wizards".split(",");
const T_MLB="Arizona Diamondbacks,Atlanta Braves,Baltimore Orioles,Boston Red Sox,Chicago Cubs,Chicago White Sox,Cincinnati Reds,Cleveland Guardians,Colorado Rockies,Detroit Tigers,Houston Astros,Kansas City Royals,Los Angeles Angels,Los Angeles Dodgers,Miami Marlins,Milwaukee Brewers,Minnesota Twins,New York Mets,New York Yankees,Oakland Athletics,Philadelphia Phillies,Pittsburgh Pirates,San Diego Padres,San Francisco Giants,Seattle Mariners,St. Louis Cardinals,Tampa Bay Rays,Texas Rangers,Toronto Blue Jays,Washington Nationals".split(",");
const T_NHL="Anaheim Ducks,Boston Bruins,Buffalo Sabres,Calgary Flames,Carolina Hurricanes,Chicago Blackhawks,Colorado Avalanche,Columbus Blue Jackets,Dallas Stars,Detroit Red Wings,Edmonton Oilers,Florida Panthers,Los Angeles Kings,Minnesota Wild,Montreal Canadiens,Nashville Predators,New Jersey Devils,New York Islanders,New York Rangers,Ottawa Senators,Philadelphia Flyers,Pittsburgh Penguins,San Jose Sharks,Seattle Kraken,St. Louis Blues,Tampa Bay Lightning,Toronto Maple Leafs,Utah Hockey Club,Vancouver Canucks,Vegas Golden Knights,Washington Capitals,Winnipeg Jets".split(",");
const T_WNBA="Atlanta Dream,Chicago Sky,Connecticut Sun,Dallas Wings,Indiana Fever,Las Vegas Aces,Los Angeles Sparks,Minnesota Lynx,New York Liberty,Phoenix Mercury,Seattle Storm,Washington Mystics".split(",");
const T_NCAAF="Air Force,Akron,Alabama,App State,Arizona,Arizona State,Arkansas,Arkansas State,Army,Auburn,Ball State,Baylor,Boise State,Boston College,Bowling Green,Buffalo,BYU,Cal,Central Michigan,Charlotte,Cincinnati,Clemson,Coastal Carolina,Colorado,Colorado State,Connecticut,Duke,East Carolina,Eastern Michigan,FAU,FIU,Florida,Florida State,Fresno State,Georgia,Georgia Southern,Georgia State,Georgia Tech,Hawaii,Houston,Illinois,Indiana,Iowa,Iowa State,Jacksonville State,James Madison,Kansas,Kansas State,Kennesaw State,Kent State,Kentucky,Liberty,Louisiana,Louisiana Tech,Louisville,LSU,Marshall,Maryland,Memphis,Miami,Miami OH,Michigan,Michigan State,Middle Tennessee,Minnesota,Mississippi State,Missouri,Navy,Nebraska,Nevada,New Mexico,New Mexico State,North Carolina,North Texas,Northern Illinois,Northwestern,Notre Dame,Ohio,Ohio State,Oklahoma,Oklahoma State,Old Dominion,Ole Miss,Oregon,Oregon State,Penn State,Pittsburgh,Purdue,Rice,Rutgers,Sam Houston,San Diego State,San Jose State,SMU,South Alabama,South Carolina,South Florida,Southern Miss,Stanford,Syracuse,TCU,Temple,Tennessee,Texas,Texas A&M,Texas State,Texas Tech,Toledo,Troy,Tulane,Tulsa,UAB,UCF,UCLA,UL Monroe,UNLV,USC,Utah,Utah State,UTEP,UTSA,Vanderbilt,Virginia,Virginia Tech,Wake Forest,Washington,Washington State,West Virginia,Western Kentucky,Western Michigan,Wisconsin,Wyoming,Abilene Christian,Albany,Austin Peay,Campbell,Central Arkansas,Chattanooga,Colgate,Dartmouth,Delaware,Duquesne,Eastern Washington,Elon,Fordham,Furman,Harvard,Holy Cross,Howard,Idaho,Idaho State,Illinois State,Indiana State,Jackson State,Lehigh,Maine,McNeese,Mercer,Missouri State,Montana,Montana State,Murray State,North Carolina A&T,North Dakota,North Dakota State,Northern Iowa,Princeton,Richmond,Sacramento State,South Dakota,South Dakota State,SE Missouri,Southern Illinois,Stephen F. Austin,Stony Brook,Tennessee State,Towson,UC Davis,Villanova,Weber State,William & Mary,Yale,Youngstown State".split(",");
const T_NCAAB="Abilene Christian,Air Force,Akron,Alabama,Albany,App State,Arizona,Arizona State,Arkansas,Arkansas State,Army,Auburn,Austin Peay,Ball State,Baylor,Belmont,Boise State,Boston College,Bowling Green,Bradley,Brown,Bryant,Bucknell,Buffalo,Butler,BYU,Cal,Campbell,Central Michigan,Charleston,Charlotte,Chattanooga,Cincinnati,Clemson,Cleveland State,Coastal Carolina,Colgate,Colorado,Colorado State,Columbia,Connecticut,Cornell,Creighton,Dartmouth,Davidson,Dayton,Delaware,DePaul,Detroit Mercy,Drake,Drexel,Duke,Duquesne,East Carolina,Eastern Kentucky,Eastern Michigan,Eastern Washington,Elon,Evansville,Fairfield,FIU,Florida,Florida Atlantic,Florida Gulf Coast,Florida State,Fordham,Fresno State,Furman,George Mason,George Washington,Georgetown,Georgia,Georgia Southern,Georgia State,Georgia Tech,Gonzaga,Grand Canyon,Hampton,Harvard,Hawaii,High Point,Hofstra,Holy Cross,Houston,Howard,Idaho,Idaho State,Illinois,Illinois State,Indiana,Indiana State,Iona,Iowa,Iowa State,Jackson State,Jacksonville,Jacksonville State,James Madison,Kansas,Kansas State,Kennesaw State,Kent State,Kentucky,La Salle,Lafayette,Lamar,Lehigh,Liberty,Lipscomb,Little Rock,Long Beach State,Longwood,Louisiana,Louisiana Tech,Louisville,Loyola Chicago,Loyola Marymount,LSU,Maine,Manhattan,Marist,Marquette,Marshall,Maryland,Massachusetts,McNeese,Memphis,Mercer,Miami,Miami OH,Michigan,Michigan State,Middle Tennessee,Milwaukee,Minnesota,Mississippi State,Missouri,Missouri State,Monmouth,Montana,Montana State,Morehead State,Morgan State,Murray State,Navy,Nebraska,Nevada,New Hampshire,New Mexico,New Mexico State,Niagara,Norfolk State,North Carolina,North Carolina A&T,North Dakota,North Dakota State,North Florida,North Texas,Northeastern,Northern Arizona,Northern Colorado,Northern Illinois,Northern Iowa,Northern Kentucky,Northwestern,Northwestern State,Notre Dame,Oakland,Ohio,Ohio State,Oklahoma,Oklahoma State,Old Dominion,Ole Miss,Omaha,Oral Roberts,Oregon,Oregon State,Pacific,Penn,Penn State,Pepperdine,Pittsburgh,Portland,Prairie View A&M,Princeton,Providence,Purdue,Quinnipiac,Radford,Rhode Island,Rice,Richmond,Rider,Robert Morris,Rutgers,Sacramento State,Sacred Heart,Saint Joseph's,Saint Louis,Saint Mary's,Sam Houston,Samford,San Diego,San Diego State,San Francisco,San Jose State,Santa Clara,Seton Hall,Siena,SMU,South Alabama,South Carolina,South Carolina State,South Dakota,South Dakota State,South Florida,Southern Illinois,Southern Miss,St. Bonaventure,St. John's,Stanford,Stephen F. Austin,Stetson,Stony Brook,Syracuse,TCU,Temple,Tennessee,Tennessee State,Tennessee Tech,Texas,Texas A&M,Texas Southern,Texas State,Texas Tech,Toledo,Towson,Troy,Tulane,Tulsa,UAB,UC Davis,UC Irvine,UC Riverside,UC San Diego,UC Santa Barbara,UCF,UCLA,UL Monroe,UMBC,UNC Greensboro,UNC Wilmington,UNLV,USC,UT Arlington,Utah,Utah State,Utah Valley,UTEP,UTSA,Valparaiso,Vanderbilt,VCU,Vermont,Villanova,Virginia,Virginia Tech,VMI,Wagner,Wake Forest,Washington,Washington State,Weber State,West Virginia,Western Carolina,Western Kentucky,Western Michigan,Wichita State,William & Mary,Winthrop,Wisconsin,Wofford,Wright State,Xavier,Yale,Youngstown State".split(",");
const GOLF_P="Scottie Scheffler,Xander Schauffele,Rory McIlroy,Collin Morikawa,Ludvig Aberg,Wyndham Clark,Patrick Cantlay,Viktor Hovland,Matt Fitzpatrick,Sahith Theegala,Keegan Bradley,Tony Finau,Shane Lowry,Tommy Fleetwood,Russell Henley,Brian Harman,Chris Kirk,Sam Burns,Sungjae Im,Tom Kim,Akshay Bhatia,Max Homa,Corey Conners,Justin Thomas,Jordan Spieth,Cameron Young,Robert MacIntyre,Denny McCarthy,Billy Horschel,Jason Day,Adam Scott,Hideki Matsuyama,Min Woo Lee,Davis Thompson,Eric Cole,Taylor Pendrith,Si Woo Kim,Nick Dunlap,Austin Eckroat,Maverick McNealy,J.T. Poston,Lucas Glover,Sepp Straka,Adam Hadwin,Harris English,Luke List,Emiliano Grillo,Alex Noren,Kurt Kitayama,Will Zalatoris,Tom Hoge,Taylor Moore,Ben Griffin,Stephan Jaeger,Mac Meissner,Jake Knapp,Christiaan Bezuidenhout,Thomas Detry,Aaron Rai,Byeong Hun An,Matthieu Pavon,Cameron Davis,Doug Ghim,Jon Rahm,Brooks Koepka,Bryson DeChambeau,Dustin Johnson,Cameron Smith,Phil Mickelson,Joaquin Niemann,Tyrrell Hatton,Abraham Ancer,Louis Oosthuizen,Sergio Garcia,Talor Gooch,Harold Varner III,Mito Pereira,Dean Burmester,Carlos Ortiz,Jason Kokrak,Charl Schwartzel,Peter Uihlein,Thomas Pieters,Adrian Meronk,David Puig,Thorbjorn Olesen,Rasmus Hojgaard,Nicolai Hojgaard,Victor Perez,Guido Migliozzi,Matteo Manassero,Ryan Fox,Adrian Otaegui,Thriston Lawrence,Yannik Paul,Sami Valimaki,Pablo Larrazabal,Justin Rose,Danny Willett,Rickie Fowler,Tiger Woods".split(",");
function getTeams(lg,custom){const base={NFL:T_NFL,NBA:T_NBA,MLB:T_MLB,NHL:T_NHL,WNBA:T_WNBA,NCAAF:T_NCAAF,NCAAB:T_NCAAB}[lg]||[];const extra=(custom&&custom[lg])||[];return[...base,...extra.filter(e=>!base.includes(e))];}
function getPlayers(sp,custom){const base=sp==="Golf"?GOLF_P:[];const extra=(custom&&custom[sp])||[];return[...base,...extra.filter(e=>!base.includes(e))];}

const SPORT_MARKETS={Football:{markets:["Spread","Moneyline","Total","Team Total","1H Spread","1H ML","1H Total","1Q Spread","1Q ML","1Q Total","Player Prop","Alt Spread","Alt Total","Other"]},Basketball:{markets:["Spread","Moneyline","Total","Team Total","1H Spread","1H ML","1H Total","1Q Spread","1Q ML","1Q Total","Player Prop","Alt Spread","Alt Total","Other"]},Baseball:{markets:["Spread","Moneyline","Total","Team Total","1H Spread","1H ML","1H Total","Player Prop","Alt Spread","Alt Total","Other"]},Hockey:{markets:["Spread","Moneyline","Total","Team Total","1P ML","1P Spread","1P Total","Player Prop","Alt Spread","Alt Total","Other"]},Soccer:{markets:["Spread","Moneyline","Total","Team Total","Draw No Bet","Double Chance","Both Teams Score","1H Spread","1H Total","Player Prop","Other"]},Tennis:{markets:["Moneyline","Spread","Total","Set Spread","Set Total","Player Prop","Other"]},MMA:{markets:["Moneyline","Method of Victory","Round Total","Fight to Go Distance","Round Betting","Other"]},Golf:{markets:["Outright Winner","Top 5","Top 10","Top 20","Matchup","1st Round Leader","Make/Miss Cut","Other"]},Other:{markets:["Spread","Moneyline","Total","Player Prop","Other"]}};
const PROP_STATS={Football:["Pass Yds","Pass TDs","INTs","Rush Yds","Rush Att","Rec Yds","Receptions","Rec TDs","Rush+Rec Yds","Completions","Kicking Pts","Tackles","Sacks","Other"],Basketball:["Points","Rebounds","Assists","3-Pointers","Steals","Blocks","Turnovers","Pts+Reb","Pts+Ast","Reb+Ast","Pts+Reb+Ast","Double Double","Other"],Baseball:["Strikeouts","Hits","Home Runs","RBIs","Runs","Bases","Walks","Outs Recorded","Stolen Bases","Other"],Hockey:["Points","Goals","Assists","Shots on Goal","Saves","Blocks","Power Play Pts","Other"],Soccer:["Goals","Assists","Shots","Shots on Target","Tackles","Cards","Other"],Tennis:["Aces","Double Faults","Games Won","Other"]};
function tmpl(s,custom){const base=SPORT_MARKETS[s]||SPORT_MARKETS.Other;const extra=(custom&&custom[s])||[];const merged=[...base.markets,...extra.filter(e=>!base.markets.includes(e))];return{markets:merged};}
function pstats(s){return PROP_STATS[s]||["Other"];}
function wantsOU(m){return["Total","Team Total","1H Total","1Q Total","1P Total","Alt Total","Round Total","Set Total","Player Prop"].includes(m);}
function wantsLine(m){return["Spread","Total","Team Total","1H Spread","1H Total","1Q Spread","1Q Total","1P Spread","1P Total","Alt Spread","Alt Total","Set Spread","Set Total","Player Prop","Round Total"].includes(m);}
function wantsSide(m){return["Spread","Moneyline","Team Total","1H Spread","1H ML","1Q Spread","1Q ML","1P ML","1P Spread","Alt Spread","Draw No Bet","Double Chance","Both Teams Score","Method of Victory","1st Round Leader","Make/Miss Cut","Other"].includes(m);}
function wantsPlayer(m){return m==="Player Prop"||["Outright Winner","Top 5","Top 10","Top 20"].includes(m);}

const DEFAULT_BOOKS=["FanDuel","DraftKings","BetMGM","Caesars","bet365","Pinnacle","Circa","BetRivers","PointsBet","Hard Rock"];
const DEFAULT_SPORTS=[{name:"Football",emoji:"ğŸˆ",leagues:["NFL","NCAAF","CFL","XFL"]},{name:"Basketball",emoji:"ğŸ€",leagues:["NBA","NCAAB","WNBA","EuroLeague"]},{name:"Baseball",emoji:"âš¾",leagues:["MLB","KBO","NPB"]},{name:"Hockey",emoji:"ğŸ’",leagues:["NHL","AHL"]},{name:"Soccer",emoji:"âš½",leagues:["EPL","La Liga","Serie A","Bundesliga","Ligue 1","MLS","Champions League"]},{name:"Tennis",emoji:"ğŸ¾",leagues:["ATP","WTA","Grand Slams"]},{name:"MMA",emoji:"ğŸ¥Š",leagues:["UFC","Bellator","PFL"]},{name:"Golf",emoji:"â›³",leagues:["PGA Tour","LIV Golf","DP World Tour","Majors"]},{name:"Other",emoji:"ğŸ¯",leagues:["Esports","Darts","Table Tennis","Other"]}];
const BET_TYPES=["Straight","Parlay","SGP","Teaser","Futures"];
const TEASER_PTS=["6","6.5","7","10"];
const FUTURES_CATS=["Outrights","Win Total","Awards","Player Props","Other"];
const RESULTS=["win","loss","push","void","half_win","half_loss","cashout"];
const RESULT_LABELS={win:"Win",loss:"Loss",push:"Push",void:"Void",half_win:"1/2 W",half_loss:"1/2 L",cashout:"CO"};
const RESULT_COLORS={win:"#22c55e",loss:"#ef4444",push:"#a3a3a3",void:"#737373",half_win:"#86efac",half_loss:"#fca5a5",cashout:"#f59e0b",pending:"#3b82f6"};
const PAGE_SIZE=10;
const KEYS={bets:"bt:bets",books:"bt:books",holders:"bt:holders",settings:"bt:settings",tags:"bt:tags",customTeams:"bt:customTeams",customPlayers:"bt:customPlayers",customMarkets:"bt:customMarkets"};
async function ld(k,fb){try{const r=await window.storage.get(k);return r?JSON.parse(r.value):fb;}catch(e){return fb;}}
async function sv(k,d){try{await window.storage.set(k,JSON.stringify(d));}catch(e){}}

// ---- AUTOCOMPLETE ----
function AutoInput({value,onChange,items,placeholder,style:sx}){
  const[open,setOpen]=useState(false);const[hi,setHi]=useState(-1);const ref=useRef(null);
  const filtered=useMemo(()=>{if(!value||!items.length)return[];const v=value.toLowerCase();return items.filter(i=>i.toLowerCase().includes(v)).slice(0,6);},[value,items]);
  const show=open&&filtered.length>0&&value.length>0;
  return(<div style={{position:"relative"}}><input value={value} onChange={e=>{onChange(e.target.value);setOpen(true);setHi(-1);}} onFocus={()=>setOpen(true)} onBlur={()=>setTimeout(()=>setOpen(false),150)} onKeyDown={e=>{if(!show)return;if(e.key==="ArrowDown"){e.preventDefault();setHi(p=>Math.min(p+1,filtered.length-1));}else if(e.key==="ArrowUp"){e.preventDefault();setHi(p=>Math.max(p-1,0));}else if(e.key==="Enter"&&hi>=0){e.preventDefault();onChange(filtered[hi]);setOpen(false);}}} placeholder={placeholder} style={{...IS,...sx}} ref={ref}/>{show&&(<div style={{position:"absolute",top:"100%",right:0,width:"auto",minWidth:160,maxWidth:260,maxHeight:192,overflowY:"auto",background:"#111118",border:"1px solid #2a2a3e",borderRadius:6,zIndex:50,marginTop:2,boxShadow:"0 8px 24px rgba(0,0,0,0.6)"}}>{filtered.map((item,i)=>(<div key={item} onMouseDown={e=>{e.preventDefault();onChange(item);setOpen(false);}} style={{padding:"6px 10px",fontSize:12,color:i===hi?"#e0e0e0":"#a0a0b8",background:i===hi?"#1a1a2e":"transparent",cursor:"pointer",borderBottom:"1px solid #1a1a28",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>{item}</div>))}</div>)}</div>);
}

// ---- APP ----
function App(){
  const[view,setView]=useState("dashboard");
  const[bets,setBets]=useState([]);const[books,setBooks]=useState(DEFAULT_BOOKS);const[holders,setHolders]=useState(["Main"]);const[tags,setTags]=useState(["Sharp","Steam","Model","Value","Promo","Freebet"]);const[settings,setSettings]=useState({unitSize:100,oddsFormat:"american"});const[customTeams,setCustomTeams]=useState({});const[customPlayers,setCustomPlayers]=useState({});const[customMarkets,setCustomMarkets]=useState({});const[loaded,setLoaded]=useState(false);const[editBet,setEditBet]=useState(null);const[repeatBet,setRepeatBet]=useState(null);const[filters,setFilters]=useState({});const[formKey,setFormKey]=useState(0);
  useEffect(()=>{(async()=>{const[b,bk,h,s,t,ct,cp,cm]=await Promise.all([ld(KEYS.bets,[]),ld(KEYS.books,DEFAULT_BOOKS),ld(KEYS.holders,["Main"]),ld(KEYS.settings,{unitSize:100,oddsFormat:"american"}),ld(KEYS.tags,["Sharp","Steam","Model","Value","Promo","Freebet"]),ld(KEYS.customTeams,{}),ld(KEYS.customPlayers,{}),ld(KEYS.customMarkets,{})]);setBets(b);setBooks(bk);setHolders(h);setSettings(s);setTags(t);setCustomTeams(ct);setCustomPlayers(cp);setCustomMarkets(cm);setLoaded(true);})();},[]);
  useEffect(()=>{if(loaded)sv(KEYS.bets,bets);},[bets,loaded]);useEffect(()=>{if(loaded)sv(KEYS.books,books);},[books,loaded]);useEffect(()=>{if(loaded)sv(KEYS.holders,holders);},[holders,loaded]);useEffect(()=>{if(loaded)sv(KEYS.settings,settings);},[settings,loaded]);useEffect(()=>{if(loaded)sv(KEYS.tags,tags);},[tags,loaded]);
  useEffect(()=>{if(loaded)sv(KEYS.customTeams,customTeams);},[customTeams,loaded]);
  useEffect(()=>{if(loaded)sv(KEYS.customPlayers,customPlayers);},[customPlayers,loaded]);
  useEffect(()=>{if(loaded)sv(KEYS.customMarkets,customMarkets);},[customMarkets,loaded]);
  const addBet=useCallback(bet=>setBets(p=>[{...bet,id:uid(),createdAt:new Date().toISOString()},...p]),[]);
  const updateBet=useCallback((id,u)=>setBets(p=>p.map(b=>b.id===id?{...b,...u,updatedAt:new Date().toISOString()}:b)),[]);
  const deleteBet=useCallback(id=>setBets(p=>p.filter(b=>b.id!==id)),[]);
  const settleBet=useCallback((id,result,cashout,gradeDate)=>{const sd=gradeDate||new Date().toISOString();setBets(p=>p.map(b=>{if(b.id!==id)return b;if(b.bookEntries&&b.bookEntries.length){const se=b.bookEntries.map(e=>({...e,result,netProfit:calc.netProfit(result,e.stake,e.toWin,cashout?cashout*e.stake/b.stake:null)}));return{...b,result,netProfit:se.reduce((s,e)=>s+(e.netProfit||0),0),cashoutAmount:cashout,settledAt:sd,bookEntries:se};}return{...b,result,netProfit:calc.netProfit(result,b.stake,b.toWin,cashout),cashoutAmount:cashout,settledAt:sd};}));},[]);
  const applyFilters=useCallback((list)=>list.filter(b=>{const f=filters;if(f.sport&&b.sport!==f.sport)return false;if(f.league&&b.league!==f.league)return false;if(f.book){if(b.bookEntries&&b.bookEntries.length){if(!b.bookEntries.some(e=>e.book===f.book))return false;}else if(b.book!==f.book)return false;}if(f.holder&&b.holder!==f.holder)return false;if(f.betType&&b.betType!==f.betType)return false;if(f.marketType&&b.marketType!==f.marketType)return false;if(f.isLive==="true"&&!b.isLive)return false;if(f.isLive==="false"&&b.isLive)return false;const filterDate=b.result&&b.settledAt?b.settledAt:b.placedAt;if(f.dateFrom&&filterDate<f.dateFrom)return false;if(f.dateTo&&filterDate>f.dateTo+"T23:59:59")return false;if(f.tag&&!(b.tags||[]).includes(f.tag))return false;if(f.search){const s=f.search.toLowerCase();if(![b.selection,b.notes,b.book,...(b.legs||[]).map(l=>l.selection),...(b.bookEntries||[]).map(e=>e.book)].filter(Boolean).join(" ").toLowerCase().includes(s))return false;}return true;}),[filters]);
  const openBets=useMemo(()=>applyFilters(bets.filter(b=>!b.result)),[bets,applyFilters]);
  const settledBets=useMemo(()=>{let list=bets.filter(b=>!!b.result);if(filters.result&&filters.result!=="pending")list=list.filter(b=>b.result===filters.result);return applyFilters(list);},[bets,filters,applyFilters]);
  const allFiltered=useMemo(()=>applyFilters(bets),[bets,applyFilters]);
  const lastBet=bets.length>0?bets[0]:null;
  const lastGolfTourney=useMemo(()=>{const g=bets.find(b=>b.sport==="Golf"&&b.tournament);return g?g.tournament:"";},[bets]);

  if(!loaded)return(<div style={{background:"#0a0a0f",color:"#e0e0e0",height:"100vh",display:"flex",alignItems:"center",justifyContent:"center"}}>Loading...</div>);
  return(
    <div style={{background:"#0a0a0f",color:"#e0e0e0",minHeight:"100vh",fontFamily:"'Inter',-apple-system,sans-serif"}}>
      <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet"/>
      <NavBar view={view} setView={setView} bc={bets.length} pc={openBets.length}/>
      <div style={{maxWidth:1400,margin:"0 auto",padding:"0 16px 80px"}}>
        {view==="dashboard"&&<Dash bets={allFiltered} allBets={bets} settings={settings} filters={filters} setFilters={setFilters} books={books} holders={holders} tags={tags}/>}
        <div style={{display:view==="new"?"block":"none"}}><BetForm key={formKey} books={books} holders={holders} tags={tags} settings={settings} lastBet={lastBet} repeatFrom={repeatBet} lastGolfTourney={lastGolfTourney} customTeams={customTeams} customPlayers={customPlayers} customMarkets={customMarkets} setCustomTeams={setCustomTeams} setCustomPlayers={setCustomPlayers} setCustomMarkets={setCustomMarkets} onSave={b=>{addBet(b);setFormKey(k=>k+1);setRepeatBet(null);setView("open");}} onCancel={()=>{setRepeatBet(null);setView("open");}} sports={DEFAULT_SPORTS}/></div>
        {view==="open"&&<OpenBets bets={openBets} allBets={bets} filters={filters} setFilters={setFilters} books={books} holders={holders} tags={tags} settings={settings} onSettle={settleBet} onDelete={deleteBet} onEdit={b=>{setEditBet(b);setView("edit");}} onNew={()=>setView("new")} onRepeat={b=>{setRepeatBet(b);setFormKey(k=>k+1);setView("new");}}/>}
        {view==="history"&&<History bets={settledBets} allBets={bets} filters={filters} setFilters={setFilters} books={books} holders={holders} tags={tags} settings={settings} onDelete={deleteBet} onEdit={b=>{setEditBet(b);setView("edit");}} onRepeat={b=>{setRepeatBet(b);setFormKey(k=>k+1);setView("new");}} updateBet={updateBet}/>}
        {view==="edit"&&editBet&&<BetForm bet={editBet} books={books} holders={holders} tags={tags} settings={settings} lastGolfTourney={lastGolfTourney} customTeams={customTeams} customPlayers={customPlayers} customMarkets={customMarkets} setCustomTeams={setCustomTeams} setCustomPlayers={setCustomPlayers} setCustomMarkets={setCustomMarkets} onSave={b=>{updateBet(editBet.id,b);setView(editBet.result?"history":"open");}} onCancel={()=>setView(editBet.result?"history":"open")} sports={DEFAULT_SPORTS} isEdit/>}
        {view==="settings"&&<SetP settings={settings} setSettings={setSettings} books={books} setBooks={setBooks} holders={holders} setHolders={setHolders} tags={tags} setTags={setTags} bets={bets} setBets={setBets}/>}
      </div>
    </div>
  );
}

function NavBar({view,setView,bc,pc}){
  const items=[{id:"dashboard",l:"Dashboard",i:"ğŸ“Š"},{id:"new",l:"New Bet",i:"â•"},{id:"open",l:"Open",i:"ğŸŸ¢",badge:pc||null},{id:"history",l:"History",i:"ğŸ“‹"},{id:"settings",l:"Settings",i:"âš™ï¸"}];
  return(<nav style={{background:"#111118",borderBottom:"1px solid #1e1e2e",padding:"0 16px",position:"sticky",top:0,zIndex:100,display:"flex",alignItems:"center",overflowX:"auto"}}><div style={{fontFamily:"'JetBrains Mono',monospace",fontWeight:700,fontSize:15,color:"#22c55e",padding:"14px 12px 14px 0",letterSpacing:"-0.5px",borderRight:"1px solid #1e1e2e",marginRight:4,flexShrink:0}}>BT<span style={{color:"#525280"}}>PRO</span></div>{items.map(it=>(<button key={it.id} onClick={()=>setView(it.id)} style={{background:view===it.id?"#1a1a2e":"transparent",border:"none",color:view===it.id?"#e0e0e0":"#6b6b8a",padding:"14px 12px",cursor:"pointer",fontSize:12,fontWeight:500,display:"flex",alignItems:"center",gap:5,borderBottom:view===it.id?"2px solid #22c55e":"2px solid transparent",whiteSpace:"nowrap",flexShrink:0}}><span>{it.i}</span>{it.l}{it.badge&&<span style={{background:"#3b82f6",color:"#fff",fontSize:10,borderRadius:8,padding:"1px 6px",fontWeight:600}}>{it.badge}</span>}</button>))}<div style={{marginLeft:"auto",fontSize:11,color:"#525280",fontFamily:"'JetBrains Mono',monospace",flexShrink:0}}>{bc}</div></nav>);
}

function FilterBar({filters,setFilters,books,holders,tags,showResult,allBets}){
  const ac=Object.values(filters).filter(Boolean).length;
  const markets=useMemo(()=>{const s=new Set();(allBets||[]).forEach(b=>{if(b.marketType)s.add(b.marketType);});return[...s].sort();},[allBets]);
  const sel=(label,key,opts,vfn)=>(<select value={filters[key]||""} onChange={e=>setFilters(f=>({...f,[key]:e.target.value||undefined}))} style={{...SS,minWidth:80}}><option value="">{label}</option>{opts.map(o=><option key={vfn?vfn(o):o} value={vfn?vfn(o):o}>{typeof o==="object"?o.emoji+" "+o.name:o}</option>)}</select>);
  return(<div style={{display:"flex",flexWrap:"wrap",gap:6,alignItems:"center",marginBottom:16}}>
    <input type="date" value={filters.dateFrom||""} onChange={e=>setFilters(f=>({...f,dateFrom:e.target.value||undefined}))} style={{...SS,width:135,colorScheme:"dark",cursor:"pointer"}}/>
    <span style={{color:"#525280",fontSize:12}}>{"â†’"}</span>
    <input type="date" value={filters.dateTo||""} onChange={e=>setFilters(f=>({...f,dateTo:e.target.value||undefined}))} style={{...SS,width:135,colorScheme:"dark",cursor:"pointer"}}/>
    {sel("Sport","sport",DEFAULT_SPORTS,s=>s.name)}{sel("League","league",DEFAULT_SPORTS.flatMap(s=>s.leagues))}{sel("Book","book",books)}{sel("Account","holder",holders)}{sel("Type","betType",BET_TYPES)}
    {markets.length>0&&sel("Market","marketType",markets)}
    {showResult&&<select value={filters.result||""} onChange={e=>setFilters(f=>({...f,result:e.target.value||undefined}))} style={{...SS,minWidth:80}}><option value="">Result</option>{RESULTS.map(r=><option key={r} value={r}>{RESULT_LABELS[r]}</option>)}</select>}
    <select value={filters.isLive||""} onChange={e=>setFilters(f=>({...f,isLive:e.target.value||undefined}))} style={SS}><option value="">Pre/Live</option><option value="true">Live</option><option value="false">Pre</option></select>
    {sel("Tag","tag",tags)}<input placeholder="Search..." value={filters.search||""} onChange={e=>setFilters(f=>({...f,search:e.target.value||undefined}))} style={{...IS,width:120}}/>{ac>0&&<button onClick={()=>setFilters({})} style={{...BS,background:"#2a1a1a",color:"#ef4444"}}>Clear ({ac})</button>}
  </div>);
}

// ---- SHARED BET ROW ----
function BetRow({bet,isExp,onToggle,children}){
  const rc=RESULT_COLORS[bet.result]||RESULT_COLORS.pending;const em=DEFAULT_SPORTS.find(s=>s.name===bet.sport)?.emoji||"";const hasMB=bet.bookEntries&&bet.bookEntries.length>0;const isPend=!bet.result;
  return(<div style={{background:"#111118",border:"1px solid "+(isExp?"#2a2a3e":"#1a1a28"),borderRadius:10,overflow:"hidden"}}>
    <div onClick={onToggle} style={{padding:"12px 14px",cursor:"pointer",display:"flex",alignItems:"center",gap:10}}>
      <div style={{width:4,height:36,borderRadius:2,background:rc,flexShrink:0}}/>
      <div style={{flex:1,minWidth:0}}>
        <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:3,flexWrap:"wrap"}}>
          <span style={{fontSize:12,color:"#6b6b8a"}}>{(bet.result&&bet.settledAt?bet.settledAt:bet.placedAt||"").slice(0,10)}</span><span style={{fontSize:11,color:"#525280"}}>{"Â·"}</span><span style={{fontSize:12,color:"#a0a0b8"}}>{hasMB?bet.bookEntries.length+" books":bet.book}</span>
          {bet.isLive&&<span style={{fontSize:9,background:"#2a1a1a",color:"#ef4444",padding:"1px 5px",borderRadius:4,fontWeight:600}}>LIVE</span>}
          {bet.betType!=="Straight"&&<span style={{fontSize:9,background:"#1a1a2e",color:"#3b82f6",padding:"1px 5px",borderRadius:4,fontWeight:600}}>{(bet.betType||"").toUpperCase()}</span>}
          {hasMB&&<span style={{fontSize:9,background:"#1a1a2e",color:"#818cf8",padding:"1px 5px",borderRadius:4,fontWeight:600}}>MULTI</span>}
          {(bet.tags||[]).includes("Freebet")&&<span style={{fontSize:9,background:"#2e2a1a",color:"#f59e0b",padding:"1px 5px",borderRadius:4,fontWeight:600}}>FREE</span>}
          {bet.tournament&&<span style={{fontSize:9,background:"#1a2e1a",color:"#22c55e",padding:"1px 5px",borderRadius:4,fontWeight:500}}>{bet.tournament}</span>}
        </div>
        <div style={{fontSize:14,fontWeight:500,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{em+" "}{bet.selection}</div>
        {bet.marketType&&<div style={{fontSize:11,color:"#525280",marginTop:2}}>{bet.marketType}</div>}
      </div>
      <div style={{textAlign:"right",flexShrink:0}}><div style={{fontSize:13,fontFamily:"'JetBrains Mono',monospace",color:hasMB?"#818cf8":"#a0a0b8"}}>{fmtOdds(bet.oddsAmer)}{hasMB?" avg":""}</div><div style={{fontSize:12,color:"#6b6b8a"}}>{"$"+fmt(bet.stake)}</div></div>
      <div style={{textAlign:"right",minWidth:70,flexShrink:0}}>{isPend?<span style={{fontSize:12,color:"#3b82f6",fontWeight:500}}>PENDING</span>:<div style={{fontSize:14,fontWeight:600,fontFamily:"'JetBrains Mono',monospace",color:rc}}>{fmtUsd(bet.netProfit)}</div>}</div>
    </div>
    {isExp&&(<div style={{padding:"0 14px 14px",borderTop:"1px solid #1a1a28"}}>{children}</div>)}
  </div>);
}
function BetDetail({bet}){
  const hasMB=bet.bookEntries&&bet.bookEntries.length>0;
  return(<>
    <div style={{display:"flex",flexWrap:"wrap",gap:12,padding:"10px 0",fontSize:12,color:"#a0a0b8"}}>
      {!hasMB&&<span><b style={{color:"#6b6b8a"}}>Account:</b> {bet.holder}</span>}{bet.placedAt&&<span><b style={{color:"#6b6b8a"}}>Placed:</b> {bet.placedAt.slice(0,10)}</span>}{bet.settledAt&&<span><b style={{color:"#6b6b8a"}}>Graded:</b> {bet.settledAt.slice(0,10)}</span>}{bet.sport&&<span><b style={{color:"#6b6b8a"}}>Sport:</b> {bet.sport}</span>}{bet.league&&<span><b style={{color:"#6b6b8a"}}>League:</b> {bet.league}</span>}{bet.line!=null&&<span><b style={{color:"#6b6b8a"}}>Line:</b> {bet.line}</span>}{bet.awayTeam&&bet.homeTeam&&<span><b style={{color:"#6b6b8a"}}>Event:</b> {bet.awayTeam+" @ "+bet.homeTeam}</span>}{bet.tournament&&<span><b style={{color:"#6b6b8a"}}>Tourney:</b> {bet.tournament}</span>}<span><b style={{color:"#6b6b8a"}}>To Win:</b> {"$"+fmt(bet.toWin)}</span>{bet.teaserPts&&<span><b style={{color:"#6b6b8a"}}>Teaser:</b> {bet.teaserPts}pt</span>}
    </div>
    {hasMB&&<div style={{marginBottom:8}}><div style={{fontSize:10,color:"#818cf8",fontWeight:600,marginBottom:4,textTransform:"uppercase"}}>Book Entries</div>{bet.bookEntries.map((e,i)=><div key={i} style={{display:"flex",alignItems:"center",gap:8,padding:"3px 0",fontSize:12,color:"#a0a0b8"}}><span style={{flex:1}}>{e.book}{e.isFree?" ğŸ†“":""}</span><span style={{width:55,fontFamily:"'JetBrains Mono',monospace",textAlign:"right"}}>{fmtOdds(e.oddsAmer)}</span><span style={{width:60,fontFamily:"'JetBrains Mono',monospace",textAlign:"right"}}>{"$"+fmt(e.stake)}</span><span style={{width:60,fontFamily:"'JetBrains Mono',monospace",textAlign:"right",color:e.netProfit!=null?(e.netProfit>=0?"#22c55e":"#ef4444"):"#525280"}}>{e.netProfit!=null?fmtUsd(e.netProfit):"â†’$"+fmt(e.toWin)}</span></div>)}</div>}
    {bet.legs&&bet.legs.length>1&&<div style={{marginBottom:8}}>{bet.legs.map((l,i)=><div key={i} style={{display:"flex",alignItems:"center",gap:8,padding:"3px 0",fontSize:12,color:"#a0a0b8"}}><span style={{color:"#525280",fontFamily:"'JetBrains Mono',monospace",fontSize:10,width:20}}>L{i+1}</span><span style={{flex:1}}>{l.selection}{l.line?" "+l.line:""}</span></div>)}</div>}
    {(bet.tags||[]).length>0&&<div style={{display:"flex",gap:4,marginBottom:8}}>{bet.tags.map(t=><span key={t} style={{fontSize:10,background:"#1a1a2e",color:"#6b6b8a",padding:"2px 8px",borderRadius:4}}>{t}</span>)}</div>}
    {bet.notes&&<div style={{fontSize:12,color:"#6b6b8a",marginBottom:8,fontStyle:"italic"}}>{bet.notes}</div>}
  </>);
}

// ---- OPEN BETS (pending, grade here) ----
function OpenBets({bets,allBets,filters,setFilters,books,holders,tags,settings,onSettle,onDelete,onEdit,onNew,onRepeat}){
  const[settleId,setSettleId]=useState(null);const[settleResult,setSettleResult]=useState("win");const[cashoutStr,setCashoutStr]=useState("");const[gradeDate,setGradeDate]=useState(nowET().slice(0,10));const[expandedId,setExpandedId]=useState(null);const[confirmDeleteId,setConfirmDeleteId]=useState(null);
  const sorted=useMemo(()=>[...bets].sort((a,b)=>(b.placedAt||"").localeCompare(a.placedAt||"")),[bets]);
  return(<div style={{paddingTop:20}}>
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}}><h2 style={{margin:0,fontSize:18,fontWeight:600}}>Open Bets <span style={{color:"#3b82f6",fontWeight:400,fontSize:14}}>({bets.length})</span></h2><button onClick={onNew} style={BP}>+ New Bet</button></div>
    <FilterBar filters={filters} setFilters={setFilters} books={books} holders={holders} tags={tags} allBets={allBets}/>
    {sorted.length===0?<div style={{textAlign:"center",padding:"60px 20px",color:"#525280"}}><div style={{fontSize:48,marginBottom:12}}>{"ğŸŸ¢"}</div><div>No open bets</div></div>:(
      <div style={{display:"flex",flexDirection:"column",gap:6}}>
        {sorted.map(bet=>{const isExp=expandedId===bet.id;const isSett=settleId===bet.id;return(
          <BetRow key={bet.id} bet={bet} isExp={isExp} onToggle={()=>setExpandedId(isExp?null:bet.id)}>
            <BetDetail bet={bet}/>
            <div style={{display:"flex",gap:8,flexWrap:"wrap"}}>
              {!isSett&&<button onClick={e=>{e.stopPropagation();setSettleId(bet.id);setSettleResult("win");setCashoutStr("");setGradeDate(nowET().slice(0,10));}} style={{...BS,background:"#1a2e1a",color:"#22c55e"}}>Grade</button>}
              <button onClick={e=>{e.stopPropagation();onEdit(bet);}} style={BS}>Edit</button>
              <button onClick={e=>{e.stopPropagation();onRepeat(bet);}} style={{...BS,color:"#818cf8"}}>Repeat</button>
              {confirmDeleteId===bet.id?<><button onClick={e=>{e.stopPropagation();onDelete(bet.id);setConfirmDeleteId(null);setExpandedId(null);}} style={{...BS,background:"#2a0a0a",color:"#ef4444",border:"1px solid #ef444444"}}>Yes</button><button onClick={e=>{e.stopPropagation();setConfirmDeleteId(null);}} style={BS}>No</button></>:<button onClick={e=>{e.stopPropagation();setConfirmDeleteId(bet.id);}} style={{...BS,color:"#ef4444"}}>Delete</button>}
            </div>
            {isSett&&<div style={{marginTop:10,background:"#0d0d14",borderRadius:8,padding:12}}>
              <div style={{display:"flex",flexWrap:"wrap",gap:6,marginBottom:10}}>{RESULTS.map(r=><button key={r} onClick={()=>setSettleResult(r)} style={{...BS,background:settleResult===r?(RESULT_COLORS[r]+"33"):"#111118",color:settleResult===r?RESULT_COLORS[r]:"#6b6b8a",border:"1px solid "+(settleResult===r?RESULT_COLORS[r]+"55":"#2a2a3e")}}>{RESULT_LABELS[r]}</button>)}</div>
              {settleResult==="cashout"&&<div style={{marginBottom:10}}><Lb>Cashout Amount</Lb><input value={cashoutStr} onChange={e=>setCashoutStr(e.target.value)} placeholder="$0.00" style={IS}/></div>}
              <div style={{marginBottom:10}}><Lb>Grade Date</Lb><input type="date" value={gradeDate} onChange={e=>setGradeDate(e.target.value)} style={{...IS,width:160,colorScheme:"dark"}}/></div>
              <div style={{fontSize:12,color:"#a0a0b8",marginBottom:10,fontFamily:"'JetBrains Mono',monospace"}}>Net P/L: <span style={{color:calc.netProfit(settleResult,bet.stake,bet.toWin,parseFloat(cashoutStr)||0)>=0?"#22c55e":"#ef4444",fontWeight:600}}>{fmtUsd(calc.netProfit(settleResult,bet.stake,bet.toWin,parseFloat(cashoutStr)||0))}</span></div>
              <div style={{display:"flex",gap:8}}><button onClick={()=>{onSettle(bet.id,settleResult,settleResult==="cashout"?parseFloat(cashoutStr)||0:null,gradeDate+"T12:00:00.000Z");setSettleId(null);}} style={{...BP,fontSize:12}}>Confirm</button><button onClick={()=>setSettleId(null)} style={BS}>Cancel</button></div>
            </div>}
          </BetRow>
        );})}
      </div>
    )}
  </div>);
}

// ---- HISTORY (settled, paginated) ----
function History({bets,allBets,filters,setFilters,books,holders,tags,settings,onDelete,onEdit,onRepeat,updateBet}){
  const[expandedId,setExpandedId]=useState(null);const[confirmDeleteId,setConfirmDeleteId]=useState(null);const[sortBy,setSortBy]=useState("settledAt");const[sortDir,setSortDir]=useState("desc");const[page,setPage]=useState(0);const[editDateId,setEditDateId]=useState(null);const[editDateVal,setEditDateVal]=useState("");
  const sorted=useMemo(()=>[...bets].sort((a,b)=>{let va=sortBy==="settledAt"?(a.settledAt||a.placedAt):a[sortBy],vb=sortBy==="settledAt"?(b.settledAt||b.placedAt):b[sortBy];if(typeof va==="string")return sortDir==="desc"?(vb||"").localeCompare(va||""):(va||"").localeCompare(vb||"");return sortDir==="desc"?(vb||0)-(va||0):(va||0)-(vb||0);}),[bets,sortBy,sortDir]);
  const totalPages=Math.ceil(sorted.length/PAGE_SIZE);const paged=sorted.slice(page*PAGE_SIZE,(page+1)*PAGE_SIZE);
  useEffect(()=>{setPage(0);},[filters,sortBy,sortDir]);
  const exportCsv=()=>{const h=["Placed","Graded","Book","Account","Type","Selection","Sport","League","Market","Line","Odds","Stake","To Win","Result","Net P&L","Tags","Notes"];const rows=sorted.map(b=>[b.placedAt?b.placedAt.slice(0,10):"",b.settledAt?b.settledAt.slice(0,10):"",b.book,b.holder,b.betType,b.selection,b.sport,b.league,b.marketType,b.line,b.oddsAmer,b.stake,b.toWin,b.result||"pending",b.netProfit!=null?b.netProfit:"",(b.tags||[]).join(";"),b.notes||""]);const csv=[h,...rows].map(r=>r.map(c=>'"'+String(c!=null?c:"").replace(/"/g,'""')+'"').join(",")).join("\n");const blob=new Blob([csv],{type:"text/csv"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="bets-"+new Date().toISOString().slice(0,10)+".csv";a.click();};
  const np=sorted.reduce((s,b)=>s+(b.netProfit||0),0);const tr=sorted.reduce((s,b)=>s+(b.stake||0),0);const hw=sorted.filter(b=>b.result==="win").length;const hl=sorted.filter(b=>b.result==="loss").length;
  return(<div style={{paddingTop:20}}>
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}}><h2 style={{margin:0,fontSize:18,fontWeight:600}}>History <span style={{color:"#525280",fontWeight:400,fontSize:14}}>({bets.length})</span></h2><button onClick={exportCsv} style={BS}>{"ğŸ“¥"} CSV</button></div>
    <FilterBar filters={filters} setFilters={setFilters} books={books} holders={holders} tags={tags} showResult allBets={allBets}/>
    {sorted.length>0&&<div style={{display:"flex",gap:16,marginBottom:12,fontSize:12,fontFamily:"'JetBrains Mono',monospace"}}><span style={{color:"#6b6b8a"}}>Record: <span style={{color:"#e0e0e0",fontWeight:600}}>{hw}-{hl}</span></span><span style={{color:"#6b6b8a"}}>P/L: <span style={{color:np>=0?"#22c55e":"#ef4444",fontWeight:600}}>{fmtUsd(np)}</span></span><span style={{color:"#6b6b8a"}}>Risked: <span style={{color:"#a0a0b8"}}>{"$"+fmt(tr)}</span></span><span style={{color:"#6b6b8a"}}>ROI: <span style={{color:np>=0?"#22c55e":"#ef4444"}}>{tr>0?(np/tr*100).toFixed(1)+"%":"--"}</span></span></div>}
    <div style={{display:"flex",gap:8,marginBottom:12,flexWrap:"wrap"}}>{[["settledAt","Graded"],["stake","Stake"],["netProfit","P&L"],["oddsAmer","Odds"]].map(([k,l])=>(<button key={k} onClick={()=>{if(sortBy===k)setSortDir(d=>d==="desc"?"asc":"desc");else{setSortBy(k);setSortDir("desc");}}} style={{...BS,background:sortBy===k?"#1a1a2e":"transparent",color:sortBy===k?"#e0e0e0":"#6b6b8a"}}>{l} {sortBy===k?(sortDir==="desc"?"â†“":"â†‘"):""}</button>))}</div>
    {paged.length===0?<div style={{textAlign:"center",padding:"60px 20px",color:"#525280"}}><div style={{fontSize:48,marginBottom:12}}>{"ğŸ“‹"}</div><div>No settled bets match</div></div>:(
      <div style={{display:"flex",flexDirection:"column",gap:6}}>
        {paged.map(bet=>{const isExp=expandedId===bet.id;return(
          <BetRow key={bet.id} bet={bet} isExp={isExp} onToggle={()=>setExpandedId(isExp?null:bet.id)}>
            <BetDetail bet={bet}/>
            <div style={{display:"flex",gap:8,flexWrap:"wrap",alignItems:"center"}}>
              <button onClick={e=>{e.stopPropagation();onEdit(bet);}} style={BS}>Edit</button>
              <button onClick={e=>{e.stopPropagation();onRepeat(bet);}} style={{...BS,color:"#818cf8"}}>Repeat</button>
              <button onClick={e=>{e.stopPropagation();if(editDateId===bet.id){setEditDateId(null);}else{setEditDateId(bet.id);setEditDateVal((bet.settledAt||bet.placedAt||"").slice(0,10));}}} style={{...BS,color:"#f59e0b"}}>Redate</button>
              {confirmDeleteId===bet.id?<><button onClick={e=>{e.stopPropagation();onDelete(bet.id);setConfirmDeleteId(null);setExpandedId(null);}} style={{...BS,background:"#2a0a0a",color:"#ef4444",border:"1px solid #ef444444"}}>Yes</button><button onClick={e=>{e.stopPropagation();setConfirmDeleteId(null);}} style={BS}>No</button></>:<button onClick={e=>{e.stopPropagation();setConfirmDeleteId(bet.id);}} style={{...BS,color:"#ef4444"}}>Delete</button>}
            </div>
            {editDateId===bet.id&&<div style={{marginTop:8,display:"flex",gap:8,alignItems:"center"}}><input type="date" value={editDateVal} onChange={e=>setEditDateVal(e.target.value)} style={{...IS,width:160,colorScheme:"dark"}}/><button onClick={e=>{e.stopPropagation();if(editDateVal&&updateBet){updateBet(bet.id,{settledAt:editDateVal+"T12:00:00.000Z"});setEditDateId(null);}}} style={{...BS,background:"#1a2e1a",color:"#22c55e"}}>Save</button><button onClick={()=>setEditDateId(null)} style={BS}>Cancel</button></div>}
          </BetRow>
        );})}
      </div>
    )}
    {totalPages>1&&<div style={{display:"flex",justifyContent:"center",alignItems:"center",gap:12,marginTop:16}}>
      {page>0&&<button onClick={()=>setPage(p=>p-1)} style={{...BS,padding:"8px 16px"}}>{"â†"} Prev</button>}
      <span style={{fontSize:12,color:"#6b6b8a"}}>{page+1} of {totalPages}</span>
      {page<totalPages-1&&<button onClick={()=>setPage(p=>p+1)} style={{...BS,padding:"8px 16px",background:"#166534",color:"#e0e0e0",border:"1px solid #22c55e44"}}>Next {"â†’"}</button>}
    </div>}
  </div>);
}

// ---- DASHBOARD ----
function Dash({bets,allBets,settings,filters,setFilters,books,holders,tags}){
  const settled=bets.filter(b=>b.result&&b.result!=="void"&&b.result!=="push");const settledAll=bets.filter(b=>b.result);
  const np=settled.reduce((s,b)=>s+(b.netProfit||0),0),tr=settled.reduce((s,b)=>s+(b.stake||0),0),wins=settled.filter(b=>b.result==="win").length,losses=settled.filter(b=>b.result==="loss").length,units=np/(settings.unitSize||100),roi=tr>0?(np/tr)*100:0,winPct=settled.length>0?(wins/settled.length)*100:0,avgStake=bets.length>0?bets.reduce((s,b)=>s+(b.stake||0),0)/bets.length:0,pending=bets.filter(b=>!b.result),pendCount=pending.length,openExposure=pending.reduce((s,b)=>s+(b.stake||0),0);
  const avgOddsCalc=useMemo(()=>{const withOdds=settled.filter(b=>b.oddsDec&&b.oddsDec>0);if(!withOdds.length)return 0;const avgDec=withOdds.reduce((s,b)=>s+b.oddsDec,0)/withOdds.length;return calc.decToAmer(avgDec);},[settled]);
  const profitOT=useMemo(()=>{const s2=settledAll.filter(b=>b.netProfit!=null).sort((a,b)=>((a.settledAt||a.placedAt)||"").localeCompare((b.settledAt||b.placedAt)||""));let cum=0;const bd={};s2.forEach(b=>{const d=dayKey(b.settledAt||b.placedAt||b.createdAt);cum+=b.netProfit||0;bd[d]=cum;});return Object.entries(bd).map(([d,v])=>({date:d,profit:Math.round(v*100)/100}));},[settledAll]);
  const byBook=useMemo(()=>{const m={};settled.forEach(b=>{if(b.bookEntries&&b.bookEntries.length)b.bookEntries.forEach(e=>{const k=e.book||"?";if(!m[k])m[k]={name:k,profit:0,count:0};m[k].profit+=e.netProfit||0;m[k].count++;});else{const k=b.book||"?";if(!m[k])m[k]={name:k,profit:0,count:0};m[k].profit+=b.netProfit||0;m[k].count++;}});return Object.values(m).sort((a,b)=>b.profit-a.profit);},[settled]);
  const mkB=fn=>{const m={};settled.forEach(b=>{const k=fn(b)||"?";if(!m[k])m[k]={name:k,profit:0,count:0};m[k].profit+=b.netProfit||0;m[k].count++;});return Object.values(m).sort((a,b)=>b.profit-a.profit);};
  const bySport=useMemo(()=>mkB(b=>b.sport),[settled]),byType=useMemo(()=>mkB(b=>b.betType),[settled]);
  const byHolder=useMemo(()=>{const m={};settled.forEach(b=>{if(b.bookEntries&&b.bookEntries.length)b.bookEntries.forEach(e=>{const k=e.holder||"Main";if(!m[k])m[k]={name:k,profit:0,count:0};m[k].profit+=e.netProfit||0;m[k].count++;});else{const k=b.holder||"Main";if(!m[k])m[k]={name:k,profit:0,count:0};m[k].profit+=b.netProfit||0;m[k].count++;}});return Object.values(m).sort((a,b)=>b.profit-a.profit);},[settled]);
  const roiOT=useMemo(()=>{const w={};settled.forEach(b=>{const d=new Date(b.settledAt||b.placedAt||b.createdAt),ws=new Date(d);ws.setDate(d.getDate()-d.getDay());const wk=ws.toISOString().slice(0,10);if(!w[wk])w[wk]={risked:0,profit:0};w[wk].risked+=b.stake||0;w[wk].profit+=b.netProfit||0;});return Object.entries(w).sort().map(([k,v])=>({week:k,roi:v.risked>0?Math.round(v.profit/v.risked*10000)/100:0,profit:Math.round(v.profit*100)/100}));},[settled]);
  const kpis=[{l:"Net Profit",v:fmtUsd(np),c:np>=0?"#22c55e":"#ef4444"},{l:"Record",v:wins+"-"+losses,c:"#c0c0d0"},{l:"Win %",v:fmt(winPct,1)+"%",c:"#c0c0d0"},{l:"Units",v:(units>=0?"+":"")+fmt(units,1)+"u",c:units>=0?"#22c55e":"#ef4444"},{l:"ROI",v:(roi>=0?"+":"")+fmt(roi,1)+"%",c:roi>=0?"#22c55e":"#ef4444"},{l:"Total Risked",v:"$"+fmt(tr),c:"#c0c0d0"},{l:"Avg Odds",v:fmtOdds(avgOddsCalc),c:"#c0c0d0"},{l:"Avg Stake",v:"$"+fmt(avgStake),c:"#c0c0d0"},{l:"Open Bets",v:""+pendCount,c:"#3b82f6"},{l:"At Risk",v:"$"+fmt(openExposure),c:"#f59e0b"}];
  const tt={background:"#1a1a2e",border:"1px solid #2a2a3e",borderRadius:8,fontSize:12};
  return(<div style={{paddingTop:20}}>
    <FilterBar filters={filters} setFilters={setFilters} books={books} holders={holders} tags={tags} showResult allBets={allBets}/>
    <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(145px,1fr))",gap:10,marginBottom:20}}>{kpis.map(k=><div key={k.l} style={{background:"#111118",borderRadius:10,padding:"14px 16px",border:"1px solid #1e1e2e"}}><div style={{fontSize:11,color:"#6b6b8a",textTransform:"uppercase",letterSpacing:"0.5px",marginBottom:6,fontWeight:500}}>{k.l}</div><div style={{fontSize:20,fontWeight:700,color:k.c,fontFamily:"'JetBrains Mono',monospace"}}>{k.v}</div></div>)}</div>
    {bets.length===0?<div style={{textAlign:"center",padding:"60px 20px",color:"#525280"}}><div style={{fontSize:48,marginBottom:12}}>{"ğŸ“Š"}</div><div>No bets yet</div></div>:(
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:14}}>
        <CC t="Cumulative Profit" s={2}><ResponsiveContainer width="100%" height={220}><LineChart data={profitOT}><CartesianGrid strokeDasharray="3 3" stroke="#1e1e2e"/><XAxis dataKey="date" tick={{fontSize:10,fill:"#525280"}} tickFormatter={v=>v.slice(5)}/><YAxis tick={{fontSize:10,fill:"#525280"}} tickFormatter={v=>"$"+v}/><Tooltip contentStyle={tt} formatter={v=>["$"+fmt(v),"Profit"]}/><Line type="monotone" dataKey="profit" stroke="#22c55e" strokeWidth={2} dot={false}/></LineChart></ResponsiveContainer></CC>
        <CC t="Weekly ROI %"><ResponsiveContainer width="100%" height={180}><BarChart data={roiOT}><CartesianGrid strokeDasharray="3 3" stroke="#1e1e2e"/><XAxis dataKey="week" tick={{fontSize:9,fill:"#525280"}} tickFormatter={v=>v.slice(5)}/><YAxis tick={{fontSize:10,fill:"#525280"}} tickFormatter={v=>v+"%"}/><Tooltip contentStyle={tt} formatter={v=>[v+"%","ROI"]}/><Bar dataKey="roi" radius={[3,3,0,0]}>{roiOT.map((e,i)=><Cell key={i} fill={e.roi>=0?"#22c55e":"#ef4444"}/>)}</Bar></BarChart></ResponsiveContainer></CC>
        <CC t="Weekly P/L"><ResponsiveContainer width="100%" height={180}><BarChart data={roiOT}><CartesianGrid strokeDasharray="3 3" stroke="#1e1e2e"/><XAxis dataKey="week" tick={{fontSize:9,fill:"#525280"}} tickFormatter={v=>v.slice(5)}/><YAxis tick={{fontSize:10,fill:"#525280"}} tickFormatter={v=>"$"+v}/><Tooltip contentStyle={tt} formatter={v=>["$"+fmt(v),"P&L"]}/><Bar dataKey="profit" radius={[3,3,0,0]}>{roiOT.map((e,i)=><Cell key={i} fill={e.profit>=0?"#22c55e":"#ef4444"}/>)}</Bar></BarChart></ResponsiveContainer></CC>
        <CC t="By Sport"><BBr data={bySport}/></CC><CC t="By Sportsbook"><BBr data={byBook}/></CC><CC t="By Bet Type"><BBr data={byType}/></CC><CC t="By Account"><BBr data={byHolder}/></CC><CC t="Results"><RP bets={bets}/></CC>
      </div>
    )}
  </div>);
}
function CC({t,children,s}){return(<div style={{background:"#111118",borderRadius:10,padding:16,border:"1px solid #1e1e2e",gridColumn:s?"span "+s:undefined}}><div style={{fontSize:12,color:"#6b6b8a",fontWeight:600,marginBottom:12,textTransform:"uppercase",letterSpacing:"0.5px"}}>{t}</div>{children}</div>);}
function BBr({data}){if(!data.length)return(<div style={{color:"#525280",fontSize:12,padding:20,textAlign:"center"}}>No data</div>);const mx=Math.max(...data.map(d=>Math.abs(d.profit)),1);return(<div style={{display:"flex",flexDirection:"column",gap:6}}>{data.slice(0,8).map(d=><div key={d.name} style={{display:"flex",alignItems:"center",gap:8}}><div style={{width:80,fontSize:11,color:"#a0a0b8",textAlign:"right",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{d.name}</div><div style={{flex:1,height:18,background:"#0a0a0f",borderRadius:3,position:"relative",overflow:"hidden"}}><div style={{position:"absolute",top:0,left:d.profit>=0?"50%":undefined,right:d.profit<0?"50%":undefined,width:(Math.abs(d.profit)/mx*50)+"%",height:"100%",background:d.profit>=0?"#22c55e33":"#ef444433",borderRadius:3}}/></div><div style={{width:70,fontSize:11,fontFamily:"'JetBrains Mono',monospace",color:d.profit>=0?"#22c55e":"#ef4444",textAlign:"right"}}>{fmtUsd(Math.round(d.profit*100)/100)}</div><div style={{width:28,fontSize:10,color:"#525280",textAlign:"right"}}>{d.count}</div></div>)}</div>);}
function RP({bets}){const c={};bets.forEach(b=>{const r=b.result||"pending";c[r]=(c[r]||0)+1;});const d=Object.entries(c).map(([n,v])=>({name:RESULT_LABELS[n]||n,value:v,fill:RESULT_COLORS[n]||"#525280"}));if(!d.length)return null;return(<ResponsiveContainer width="100%" height={180}><PieChart><Pie data={d} cx="50%" cy="50%" innerRadius={40} outerRadius={70} paddingAngle={2} dataKey="value">{d.map((e,i)=><Cell key={i} fill={e.fill}/>)}</Pie><Tooltip contentStyle={{background:"#1a1a2e",border:"1px solid #2a2a3e",borderRadius:8,fontSize:12}}/></PieChart></ResponsiveContainer>);}

// ---- BET FORM ----
function BetForm({bet,books,holders,tags,settings,onSave,onCancel,sports,isEdit,lastBet,repeatFrom,lastGolfTourney,customTeams,customPlayers,customMarkets,setCustomTeams,setCustomPlayers,setCustomMarkets}){
  const D=bet||{};const R=repeatFrom||{};
  const dfSport=R.sport||D.sport||(lastBet?lastBet.sport:"")||guessSeasonSport();const dfLeague=R.league||D.league||(lastBet?lastBet.league:"")||"";
  const dfBook=R.book||D.book||books[0]||"";const dfHolder=R.holder||D.holder||holders[0]||"";
  const[placedAt,setPlacedAt]=useState(D.placedAt?D.placedAt.slice(0,16):nowET());const[sport,setSport]=useState(dfSport);const[league,setLeague]=useState(dfLeague);const[book,setBook]=useState(dfBook);const[holder,setHolder]=useState(dfHolder);const[betType,setBetType]=useState(R.betType||D.betType||"Straight");const[isLive,setIsLive]=useState(R.isLive||D.isLive||false);const[marketType,setMarketType]=useState(R.marketType||D.marketType||tmpl(dfSport,customMarkets).markets[0]||"Spread");const[awayTeam,setAwayTeam]=useState(R.awayTeam||D.awayTeam||"");const[homeTeam,setHomeTeam]=useState(R.homeTeam||D.homeTeam||"");const[betSide,setBetSide]=useState(R.betSide||D.betSide||"away");const[overUnder,setOverUnder]=useState(R.overUnder||D.overUnder||"Over");const[line,setLine]=useState(R.line!=null?""+R.line:D.line!=null?""+D.line:"");const[participant,setParticipant]=useState(D.participant||"");const[propStat,setPropStat]=useState(R.propStat||D.propStat||"");const[futCat,setFutCat]=useState(R.futCat||D.futCat||"Outrights");const[futDesc,setFutDesc]=useState(R.futDesc||D.futDesc||"");const[teaserPts,setTeaserPts]=useState(R.teaserPts||D.teaserPts||"6");const[matchP1,setMatchP1]=useState(D.matchP1||"");const[matchP2,setMatchP2]=useState(D.matchP2||"");const[matchSide,setMatchSide]=useState(R.matchSide||D.matchSide||"p1");const[tournament,setTournament]=useState(R.tournament||D.tournament||(dfSport==="Golf"?lastGolfTourney:"")||"");const[oddsStr,setOddsStr]=useState(D.oddsAmer!=null?""+D.oddsAmer:"");const[oddsFormat]=useState(settings.oddsFormat||"american");const[riskMode,setRiskMode]=useState("risk");const[stakeStr,setStakeStr]=useState(D.stake!=null?""+D.stake:"");const[toWinStr,setToWinStr]=useState(D.toWin!=null?""+D.toWin:"");const[freebetVal,setFreebetVal]=useState("");const[notes,setNotes]=useState(D.notes||"");const[selTags,setSelTags]=useState(R.tags||D.tags||[]);const[legs,setLegs]=useState(D.legs||[]);const[multiBook,setMultiBook]=useState(!!(D.bookEntries&&D.bookEntries.length)||!!(R.bookEntries&&R.bookEntries.length));
  const[newMarket,setNewMarket]=useState("");const[showAddMarket,setShowAddMarket]=useState(false);
  const initME=D.bookEntries&&D.bookEntries.length?D.bookEntries:R.bookEntries&&R.bookEntries.length?R.bookEntries:null;
  const[multiEntries,setMultiEntries]=useState(initME?initME.map(e=>({id:uid(),book:e.book,holder:e.holder,oddsStr:D.bookEntries?e.oddsAmer!=null?""+e.oddsAmer:"":"",stakeStr:D.bookEntries?e.stake!=null?""+e.stake:"":"",toWinStr:D.bookEntries?e.toWin!=null?""+e.toWin:"":"",riskMode:"risk",isFree:e.isFree||false,freeVal:""})):[{id:uid(),book:dfBook,holder:dfHolder,oddsStr:"",stakeStr:"",toWinStr:"",riskMode:"risk",isFree:false,freeVal:""}]);

  // Auto-fill tournament when switching to golf
  useEffect(()=>{if(sport==="Golf"&&!tournament&&lastGolfTourney)setTournament(lastGolfTourney);},[sport]);

  const isML=betType==="Parlay"||betType==="SGP"||betType==="Teaser";const isFut=betType==="Futures";const isStraight=betType==="Straight";const isTeaser=betType==="Teaser";const isProp=marketType==="Player Prop";const isMatchup=marketType==="Matchup";const isFreeBet=selTags.includes("Freebet")&&!multiBook;
  const T=tmpl(sport||"Other",customMarkets);const sportObj=sports.find(s=>s.name===sport);const leagueOpts=sportObj?sportObj.leagues:sports.flatMap(s=>s.leagues);const teamList=getTeams(league,customTeams);const playerList=getPlayers(sport,customPlayers);const teamName=betSide==="away"?awayTeam:homeTeam;

  const pO=str=>{const n=parseFloat(str);if(isNaN(n)||!(str||"").trim())return{oddsDec:null,oddsAmer:null};if(oddsFormat==="american"&&n!==0&&(n>=100||n<=-100))return{oddsDec:calc.amerToDec(n),oddsAmer:Math.round(n)};if(oddsFormat==="decimal"&&n>=1.01)return{oddsDec:n,oddsAmer:calc.decToAmer(n)};return{oddsDec:null,oddsAmer:null};};
  const{oddsDec,oddsAmer}=pO(oddsStr);
  useEffect(()=>{if(multiBook||!oddsDec)return;if(isFreeBet){setStakeStr("0");if(freebetVal){const fv=parseFloat(freebetVal);if(!isNaN(fv)&&fv>0)setToWinStr(""+calc.toWin(fv,oddsDec));}return;}if(riskMode==="risk"&&stakeStr){const s=parseFloat(stakeStr);if(!isNaN(s)&&s>0)setToWinStr(""+calc.toWin(s,oddsDec));}}, [stakeStr,oddsDec,riskMode,multiBook,isFreeBet,freebetVal]);
  useEffect(()=>{if(multiBook||!oddsDec||isFreeBet)return;if(riskMode==="towin"&&toWinStr){const tw=parseFloat(toWinStr);if(!isNaN(tw)&&tw>0)setStakeStr(""+calc.stake(tw,oddsDec));}}, [toWinStr,oddsDec,riskMode,multiBook,isFreeBet]);
  const uME=(id,f,v)=>setMultiEntries(p=>p.map(e=>{if(e.id!==id)return e;const u={...e,[f]:v};if(f==="stakeStr")u.riskMode="risk";if(f==="toWinStr")u.riskMode="towin";if(f==="isFree"&&v){u.stakeStr="0";u.riskMode="risk";}const{oddsDec:od}=pO(u.oddsStr);if(od){if(u.isFree&&u.freeVal){const fv=parseFloat(u.freeVal);if(!isNaN(fv)&&fv>0){u.stakeStr="0";u.toWinStr=""+calc.toWin(fv,od);}}else if(u.riskMode==="risk"&&u.stakeStr){const s=parseFloat(u.stakeStr);if(!isNaN(s)&&s>0)u.toWinStr=""+calc.toWin(s,od);}else if(u.riskMode==="towin"&&u.toWinStr){const tw=parseFloat(u.toWinStr);if(!isNaN(tw)&&tw>0)u.stakeStr=""+calc.stake(tw,od);}}return u;}));
  const addME=()=>setMultiEntries(p=>[...p,{id:uid(),book:books[0]||"",holder:holders[0]||"",oddsStr:"",stakeStr:"",toWinStr:"",riskMode:"risk",isFree:false,freeVal:""}]);const rmME=id=>setMultiEntries(p=>p.filter(e=>e.id!==id));
  const mT=useMemo(()=>{if(!multiBook)return null;const ents=multiEntries.map(e=>{const{oddsDec:od,oddsAmer:oa}=pO(e.oddsStr);return{...e,oddsDec:od,oddsAmer:oa,stake:e.isFree?0:parseFloat(e.stakeStr)||0,toWin:parseFloat(e.toWinStr)||0};});const ts=ents.reduce((s,e)=>s+e.stake,0);const tw=ents.reduce((s,e)=>s+e.toWin,0);const ad=calc.avgDecOdds(ents);return{totalStake:ts,totalToWin:tw,avgDec:ad,avgAmer:ad?calc.decToAmer(ad):null,count:ents.length,entries:ents};},[multiBook,multiEntries]);
  const addLeg=()=>setLegs(p=>[...p,{id:uid(),selection:"",line:""}]);const uLeg=(id,f,v)=>setLegs(p=>p.map(l=>l.id===id?{...l,[f]:v}:l));const rmLeg=id=>setLegs(p=>p.filter(l=>l.id!==id));
  useEffect(()=>{if(isML&&legs.length<2)setLegs([{id:uid(),selection:"",line:""},{id:uid(),selection:"",line:""}]);},[isML]);

  const selPreview=useMemo(()=>{
    if(isML){const ls=legs.map(l=>{const s=l.selection||"";const ln=l.line?((parseFloat(l.line)>0?"+":"")+parseFloat(l.line)):"";return(s+(ln?" "+ln:"")).trim();}).filter(Boolean).join(" / ");return isTeaser?ls+(ls?" ("+teaserPts+"pt)":""):ls;}
    if(isFut){switch(futCat){case"Outrights":return(teamName||participant||"?")+" "+(futDesc||"?");case"Win Total":return(teamName||"?")+" "+(overUnder||"O")+" "+(line||"?")+" Wins";case"Awards":return(participant||"?")+" - "+(futDesc||"?");case"Player Props":return(participant||"?")+" "+(overUnder||"O")+" "+(line||"?")+(propStat?" "+propStat:"");default:return futDesc||"?";}}
    if(isMatchup)return buildDisplay("Matchup",teamName,line,overUnder,participant,propStat,matchP1,matchP2,matchSide);
    return buildDisplay(marketType,teamName,line,overUnder,participant,propStat);
  },[isML,isFut,legs,teaserPts,futCat,teamName,participant,line,overUnder,propStat,futDesc,marketType,isTeaser,isMatchup,matchP1,matchP2,matchSide]);

  const hasSel=isML?legs.length>=2&&legs.every(l=>l.selection):!!selPreview.trim()&&!selPreview.includes("?");const hasOdds=multiBook?multiEntries.every(e=>pO(e.oddsStr).oddsDec!=null):oddsDec!=null;const hasSt=multiBook?multiEntries.every(e=>e.isFree?!!e.freeVal:!!(e.stakeStr||e.toWinStr)):isFreeBet?!!freebetVal:!!(stakeStr||toWinStr);const canSave=hasSel&&hasOdds&&hasSt&&!!sport;

  const handleSave=()=>{
    // Learn new teams/players
    if(setCustomTeams&&league){const builtIn=getTeams(league,{});const toCheck=[awayTeam,homeTeam].filter(t=>t&&t.trim()&&!builtIn.includes(t)&&!((customTeams||{})[league]||[]).includes(t));if(toCheck.length)setCustomTeams(prev=>({...prev,[league]:[...((prev||{})[league]||[]),...toCheck]}));}
    if(setCustomPlayers&&sport){const builtIn=getPlayers(sport,{});const pToCheck=[participant,matchP1,matchP2].filter(p=>p&&p.trim()&&!builtIn.includes(p)&&!((customPlayers||{})[sport]||[]).includes(p));if(pToCheck.length)setCustomPlayers(prev=>({...prev,[sport]:[...((prev||{})[sport]||[]),...pToCheck]}));}
    const fs=selPreview;const sk=isFreeBet?0:parseFloat(stakeStr)||0;const tw=parseFloat(toWinStr)||0;
    const base={betType,isLive,sport,league,selection:fs,marketType:isML?betType:isFut?futCat:marketType,line:line?parseFloat(line):null,participant:isProp?participant:isFut?participant:wantsPlayer(marketType)?participant:isMatchup?(matchSide==="p2"?matchP2:matchP1):teamName,propStat,overUnder,awayTeam,homeTeam,betSide,futCat:isFut?futCat:undefined,futDesc:isFut?futDesc:undefined,teaserPts:isTeaser?teaserPts:undefined,matchP1:isMatchup?matchP1:undefined,matchP2:isMatchup?matchP2:undefined,matchSide:isMatchup?matchSide:undefined,tournament:sport==="Golf"?tournament:undefined,oddsAmer,oddsDec,notes,tags:selTags,placedAt,legs:isML?legs:[{id:uid(),legNumber:1,selection:fs,marketType,line:line?parseFloat(line):null}],result:D.result||null,netProfit:D.netProfit!=null?D.netProfit:null};
    if(multiBook&&mT){const be=mT.entries.map(e=>({book:multiEntries.find(m=>m.id===e.id)?.book||"",holder:multiEntries.find(m=>m.id===e.id)?.holder||"",oddsAmer:e.oddsAmer,oddsDec:e.oddsDec,stake:e.stake,toWin:e.toWin,isFree:e.isFree||false}));onSave({...base,book:be.map(e=>e.book).join(", "),holder:be[0]?.holder||holder,oddsAmer:mT.avgAmer,oddsDec:mT.avgDec,stake:mT.totalStake,toWin:mT.totalToWin,potentialPayout:mT.totalStake+mT.totalToWin,bookEntries:be});}
    else onSave({...base,book,holder,stake:sk,toWin:tw,potentialPayout:sk+tw});
  };

  const ouBtn=(<div style={{display:"flex",gap:4}}>{["Over","Under"].map(v=>(<button key={v} onClick={()=>setOverUnder(v)} style={{...BS,padding:"5px 14px",background:overUnder===v?(v==="Over"?"#1a2e1a":"#2a1a1a"):"transparent",color:overUnder===v?(v==="Over"?"#22c55e":"#ef4444"):"#525280",border:"1px solid "+(overUnder===v?(v==="Over"?"#22c55e44":"#ef444444"):"#1e1e2e"),fontWeight:600}}>{v}</button>))}</div>);

  return(
    <div style={{paddingTop:20,maxWidth:620,margin:"0 auto"}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}><h2 style={{margin:0,fontSize:18,fontWeight:600}}>{isEdit?"Edit Bet":"New Bet"}</h2><button onClick={onCancel} style={BS}>Cancel</button></div>
      {sport&&selPreview&&!selPreview.includes("?")&&(<div style={{background:"#0d0d18",border:"1px solid #22c55e33",borderRadius:8,padding:"10px 14px",marginBottom:12,fontFamily:"'JetBrains Mono',monospace",fontSize:14,color:"#e0e0e0",fontWeight:600}}>{(sportObj?.emoji||"")+" "}{selPreview}{oddsStr&&oddsDec?<span style={{color:"#818cf8",marginLeft:10}}>{fmtOdds(oddsAmer)}</span>:null}</div>)}
      {/* 1 */}
      <Sec c="#22c55e" label={"1 - Date"+DOT+"Sport"+DOT+"Book"}>
        <div style={{marginBottom:10}}><Lb>Date/Time (ET)</Lb><input type="datetime-local" value={placedAt} onChange={e=>setPlacedAt(e.target.value)} style={IS}/></div>
        <div style={{display:"flex",gap:8,marginBottom:10}}><div style={{flex:1}}><Lb>Sport</Lb><select value={sport} onChange={e=>{setSport(e.target.value);setLeague("");setMarketType(tmpl(e.target.value,customMarkets).markets[0]||"Spread");if(e.target.value==="Golf"&&lastGolfTourney)setTournament(lastGolfTourney);else setTournament("");}} style={SS}><option value="">Pick sport...</option>{sports.map(s=><option key={s.name} value={s.name}>{s.emoji+" "+s.name}</option>)}</select></div><div style={{flex:1}}><Lb>League</Lb><select value={league} onChange={e=>setLeague(e.target.value)} style={SS}><option value="">{"â€”"}</option>{leagueOpts.map(l=><option key={l}>{l}</option>)}</select></div></div>
        {sport==="Golf"&&<div style={{marginBottom:10}}><Lb>Tournament</Lb><input value={tournament} onChange={e=>setTournament(e.target.value)} placeholder="e.g. The Masters" style={IS}/></div>}
        {!multiBook&&<div style={{display:"flex",gap:8}}><div style={{flex:1}}><Lb>Sportsbook</Lb><select value={book} onChange={e=>setBook(e.target.value)} style={SS}>{books.map(b=><option key={b}>{b}</option>)}</select></div><div style={{flex:1}}><Lb>Account</Lb><select value={holder} onChange={e=>setHolder(e.target.value)} style={SS}>{holders.map(h=><option key={h}>{h}</option>)}</select></div></div>}
      </Sec>
      {sport&&<>
      {/* 2 */}
      <Sec c="#818cf8" label={"2 - Type"+DOT+"Market"}>
        <div style={{display:"flex",gap:8,marginBottom:10,flexWrap:"wrap"}}><div style={{flex:1,minWidth:100}}><Lb>Bet Type</Lb><select value={betType} onChange={e=>setBetType(e.target.value)} style={SS}>{BET_TYPES.map(t=><option key={t}>{t}</option>)}</select></div>{isStraight&&<div style={{flex:1,minWidth:100}}><Lb>Market</Lb><div style={{display:"flex",gap:4}}><select value={marketType} onChange={e=>setMarketType(e.target.value)} style={{...SS,flex:1}}>{T.markets.map(m=><option key={m}>{m}</option>)}</select><button onClick={()=>setShowAddMarket(!showAddMarket)} style={{...BS,padding:"6px 8px",fontSize:11}}>+</button></div>{showAddMarket&&<div style={{display:"flex",gap:4,marginTop:4}}><input value={newMarket} onChange={e=>setNewMarket(e.target.value)} placeholder="New market..." style={{...IS,flex:1,fontSize:11}} onKeyDown={e=>{if(e.key==="Enter"&&newMarket.trim()){if(setCustomMarkets)setCustomMarkets(prev=>({...prev,[sport]:[...((prev||{})[sport]||[]),newMarket.trim()]}));setMarketType(newMarket.trim());setNewMarket("");setShowAddMarket(false);}}}/><button onClick={()=>{if(newMarket.trim()){if(setCustomMarkets)setCustomMarkets(prev=>({...prev,[sport]:[...((prev||{})[sport]||[]),newMarket.trim()]}));setMarketType(newMarket.trim());setNewMarket("");setShowAddMarket(false);}}} style={{...BS,padding:"4px 8px",background:"#1a2e1a",color:"#22c55e"}}>Add</button></div>}</div>}{isTeaser&&<div style={{minWidth:90}}><Lb>Points</Lb><select value={teaserPts} onChange={e=>setTeaserPts(e.target.value)} style={SS}>{TEASER_PTS.map(p=><option key={p}>{p}pt</option>)}</select></div>}{isFut&&<div style={{flex:1,minWidth:100}}><Lb>Category</Lb><select value={futCat} onChange={e=>setFutCat(e.target.value)} style={SS}>{FUTURES_CATS.map(c=><option key={c}>{c}</option>)}</select></div>}</div>
        <div style={{display:"flex",gap:6}}><button onClick={()=>setIsLive(!isLive)} style={{...BS,background:isLive?"#1a2e1a":"transparent",color:isLive?"#22c55e":"#6b6b8a",border:"1px solid "+(isLive?"#22c55e44":"#2a2a3e")}}>{isLive?"ğŸ”´ LIVE":"â± Pre"}</button><button onClick={()=>setMultiBook(!multiBook)} style={{...BS,background:multiBook?"#1a1a3e":"transparent",color:multiBook?"#818cf8":"#6b6b8a",border:"1px solid "+(multiBook?"#818cf855":"#2a2a3e")}}>{multiBook?"ğŸ“š Multi-Book":"ğŸ“– Single"}</button></div>
      </Sec>
      {/* 3 */}
      <Sec c="#f59e0b" label="3 - Selection">
        {isML?(<div>{legs.map((leg,i)=>(<div key={leg.id} style={{background:"#0d0d14",border:"1px solid #1a1a28",borderRadius:8,padding:10,marginBottom:6}}><div style={{display:"flex",justifyContent:"space-between",marginBottom:4}}><span style={{fontSize:10,color:"#6b6b8a",fontWeight:600}}>LEG {i+1}</span>{legs.length>2&&<button onClick={()=>rmLeg(leg.id)} style={{background:"none",border:"none",color:"#ef4444",cursor:"pointer",fontSize:13}}>{"âœ•"}</button>}</div><div style={{display:"flex",gap:6}}><AutoInput value={leg.selection} onChange={v=>uLeg(leg.id,"selection",v)} items={teamList} placeholder="e.g. Bengals" style={{flex:2}}/><input placeholder="Line" value={leg.line||""} onChange={e=>uLeg(leg.id,"line",e.target.value)} style={{...IS,width:70,fontFamily:"'JetBrains Mono',monospace"}}/></div></div>))}<button onClick={addLeg} style={{...BS,width:"100%",justifyContent:"center"}}>+ Add Leg</button></div>
        ):isFut?(<div>{(futCat==="Outrights"||futCat==="Win Total")&&(<div style={{marginBottom:8}}><Lb>Team / Selection</Lb><AutoInput value={awayTeam} onChange={v=>{setAwayTeam(v);setBetSide("away");}} items={teamList} placeholder="e.g. Chiefs"/></div>)}{(futCat==="Awards"||futCat==="Player Props")&&(<div style={{display:"flex",gap:8,marginBottom:8}}><div style={{flex:2}}><Lb>Player</Lb><AutoInput value={participant} onChange={setParticipant} items={playerList.length?playerList:teamList} placeholder="e.g. Mahomes"/></div>{futCat==="Player Props"&&pstats(sport).length>0&&<div style={{flex:1}}><Lb>Stat</Lb><select value={propStat} onChange={e=>setPropStat(e.target.value)} style={SS}><option value="">{"â€”"}</option>{pstats(sport).map(s=><option key={s}>{s}</option>)}</select></div>}</div>)}{(futCat==="Win Total"||futCat==="Player Props")&&(<><div style={{marginBottom:8}}><Lb>Over / Under</Lb>{ouBtn}</div><div style={{marginBottom:8,width:140}}><Lb>Line</Lb><input value={line} onChange={e=>setLine(e.target.value)} placeholder="11.5" style={{...IS,fontFamily:"'JetBrains Mono',monospace"}}/></div></>)}{(futCat==="Outrights"||futCat==="Awards"||futCat==="Other")&&(<div style={{marginBottom:8}}><Lb>{futCat==="Awards"?"Award Name":"Description"}</Lb><input value={futDesc} onChange={e=>setFutDesc(e.target.value)} placeholder={futCat==="Awards"?"e.g. NFL MVP":"e.g. Super Bowl Champion"} style={IS}/></div>)}</div>
        ):isMatchup?(<div><div style={{display:"flex",gap:8,marginBottom:8}}><div style={{flex:1}}><Lb>Player 1</Lb><AutoInput value={matchP1} onChange={setMatchP1} items={playerList} placeholder="e.g. Scheffler"/></div><span style={{color:"#525280",marginTop:20,fontSize:13}}>vs</span><div style={{flex:1}}><Lb>Player 2</Lb><AutoInput value={matchP2} onChange={setMatchP2} items={playerList} placeholder="e.g. McIlroy"/></div></div>{matchP1&&matchP2&&(<div style={{marginBottom:8}}><Lb>Betting On</Lb><div style={{display:"flex",gap:4}}><button onClick={()=>setMatchSide("p1")} style={{...BS,flex:1,justifyContent:"center",padding:"7px 12px",background:matchSide==="p1"?"#1a1a3e":"transparent",color:matchSide==="p1"?"#818cf8":"#525280",border:"1px solid "+(matchSide==="p1"?"#818cf855":"#1e1e2e"),fontWeight:600}}>{matchP1}</button><button onClick={()=>setMatchSide("p2")} style={{...BS,flex:1,justifyContent:"center",padding:"7px 12px",background:matchSide==="p2"?"#1a1a3e":"transparent",color:matchSide==="p2"?"#818cf8":"#525280",border:"1px solid "+(matchSide==="p2"?"#818cf855":"#1e1e2e"),fontWeight:600}}>{matchP2}</button></div></div>)}</div>
        ):(<div>
          {(teamList.length>0||sport!=="Golf")&&!wantsPlayer(marketType)&&(<div style={{display:"flex",gap:6,alignItems:"center",marginBottom:10}}><div style={{flex:1}}><Lb>Away</Lb><AutoInput value={awayTeam} onChange={setAwayTeam} items={teamList} placeholder="Away team"/></div><span style={{color:"#525280",marginTop:16,fontSize:13}}>@</span><div style={{flex:1}}><Lb>Home</Lb><AutoInput value={homeTeam} onChange={setHomeTeam} items={teamList} placeholder="Home team"/></div></div>)}
          {wantsSide(marketType)&&!wantsPlayer(marketType)&&(awayTeam||homeTeam)&&(<div style={{marginBottom:8}}><Lb>Betting On</Lb><div style={{display:"flex",gap:4}}>{awayTeam&&<button onClick={()=>setBetSide("away")} style={{...BS,flex:1,justifyContent:"center",padding:"7px 12px",background:betSide==="away"?"#1a1a3e":"transparent",color:betSide==="away"?"#818cf8":"#525280",border:"1px solid "+(betSide==="away"?"#818cf855":"#1e1e2e"),fontWeight:600}}>{awayTeam}</button>}{homeTeam&&<button onClick={()=>setBetSide("home")} style={{...BS,flex:1,justifyContent:"center",padding:"7px 12px",background:betSide==="home"?"#1a1a3e":"transparent",color:betSide==="home"?"#818cf8":"#525280",border:"1px solid "+(betSide==="home"?"#818cf855":"#1e1e2e"),fontWeight:600}}>{homeTeam}</button>}</div></div>)}
          {wantsPlayer(marketType)&&(<div style={{marginBottom:8}}>{sport!=="Golf"&&teamList.length>0&&(<div style={{display:"flex",gap:6,alignItems:"center",marginBottom:8}}><div style={{flex:1}}><Lb>Away</Lb><AutoInput value={awayTeam} onChange={setAwayTeam} items={teamList} placeholder="Away"/></div><span style={{color:"#525280",marginTop:16,fontSize:13}}>@</span><div style={{flex:1}}><Lb>Home</Lb><AutoInput value={homeTeam} onChange={setHomeTeam} items={teamList} placeholder="Home"/></div></div>)}<div style={{display:"flex",gap:8}}><div style={{flex:2}}><Lb>Player</Lb><AutoInput value={participant} onChange={setParticipant} items={playerList.length?playerList:[]} placeholder="e.g. Mahomes"/></div>{isProp&&pstats(sport).length>0&&<div style={{flex:1}}><Lb>Stat</Lb><select value={propStat} onChange={e=>setPropStat(e.target.value)} style={SS}><option value="">{"â€”"}</option>{pstats(sport).map(s=><option key={s}>{s}</option>)}</select></div>}</div></div>)}
          {wantsOU(marketType)&&<div style={{marginBottom:8}}><Lb>Over / Under</Lb>{ouBtn}</div>}
          {wantsLine(marketType)&&<div style={{marginBottom:8,width:140}}><Lb>{marketType.includes("Spread")?"Spread":"Line"}</Lb><input value={line} onChange={e=>setLine(e.target.value)} placeholder={marketType.includes("Spread")?"-3.5":"220.5"} style={{...IS,fontFamily:"'JetBrains Mono',monospace"}}/></div>}
        </div>)}
      </Sec>
      {/* 4 */}
      <Sec c="#ef4444" label="4 - Odds & Stake">
        {multiBook?(<div>{multiEntries.map(entry=>(<div key={entry.id} style={{background:"#0d0d14",border:"1px solid "+(entry.isFree?"#f59e0b33":"#1a1a28"),borderRadius:8,padding:10,marginBottom:6}}><div style={{display:"flex",gap:6,marginBottom:6,alignItems:"center"}}><select value={entry.book} onChange={e=>uME(entry.id,"book",e.target.value)} style={{...SS,flex:1}}>{books.map(b=><option key={b}>{b}</option>)}</select><select value={entry.holder} onChange={e=>uME(entry.id,"holder",e.target.value)} style={{...SS,width:85}}>{holders.map(h=><option key={h}>{h}</option>)}</select><button onClick={()=>uME(entry.id,"isFree",!entry.isFree)} style={{...BS,padding:"4px 8px",fontSize:10,background:entry.isFree?"#2e2a1a":"transparent",color:entry.isFree?"#f59e0b":"#525280",border:"1px solid "+(entry.isFree?"#f59e0b44":"#1e1e2e")}}>FREE</button>{multiEntries.length>1&&<button onClick={()=>rmME(entry.id)} style={{background:"none",border:"none",color:"#ef4444",cursor:"pointer",fontSize:13}}>{"âœ•"}</button>}</div><div style={{display:"flex",gap:6}}><input placeholder="-110" value={entry.oddsStr} onChange={e=>uME(entry.id,"oddsStr",e.target.value)} style={{...IS,width:75,textAlign:"center",fontFamily:"'JetBrains Mono',monospace"}}/>{entry.isFree?(<><input placeholder="Freebet $" value={entry.freeVal} onChange={e=>uME(entry.id,"freeVal",e.target.value)} style={{...IS,flex:1,borderColor:"#f59e0b33"}}/>{entry.toWinStr&&<div style={{fontSize:11,color:"#22c55e",fontFamily:"'JetBrains Mono',monospace",minWidth:60,textAlign:"right",alignSelf:"center"}}>{"$"+fmt(parseFloat(entry.toWinStr)||0)}</div>}</>):(<><input placeholder="Risk $" value={entry.stakeStr} onChange={e=>uME(entry.id,"stakeStr",e.target.value)} style={{...IS,flex:1}}/><input placeholder="To Win $" value={entry.toWinStr} onChange={e=>uME(entry.id,"toWinStr",e.target.value)} style={{...IS,flex:1}}/></>)}</div></div>))}<button onClick={addME} style={{...BS,width:"100%",justifyContent:"center"}}>+ Add Book</button>{mT&&(mT.totalStake>0||mT.totalToWin>0)&&<div style={{background:"#0d0d18",border:"1px solid #1e1e2e",borderRadius:8,padding:"10px 12px",marginTop:8,fontFamily:"'JetBrains Mono',monospace",fontSize:12}}><div style={{display:"flex",justifyContent:"space-between",marginBottom:3}}><span style={{color:"#6b6b8a"}}>{mT.count} books avg</span><span style={{color:"#818cf8",fontWeight:600}}>{fmtOdds(mT.avgAmer)}</span></div><div style={{display:"flex",justifyContent:"space-between",marginBottom:3}}><span style={{color:"#6b6b8a"}}>Risk</span><span style={{color:"#e0e0e0",fontWeight:600}}>{"$"+fmt(mT.totalStake)}</span></div><div style={{display:"flex",justifyContent:"space-between"}}><span style={{color:"#6b6b8a"}}>To Win</span><span style={{color:"#22c55e",fontWeight:600}}>{"$"+fmt(mT.totalToWin)}</span></div></div>}</div>
        ):(<div><div style={{marginBottom:10}}><Lb>Odds</Lb><input value={oddsStr} onChange={e=>setOddsStr(e.target.value)} placeholder="-110, +150" style={IS}/>{oddsDec&&<div style={{fontSize:11,color:"#525280",marginTop:3,fontFamily:"'JetBrains Mono',monospace"}}>Dec: {fmt(oddsDec,3)}{DOT}Implied: {fmt(1/oddsDec*100,1)}%</div>}</div>{isFreeBet?(<div><Lb>Freebet Value</Lb><input value={freebetVal} onChange={e=>setFreebetVal(e.target.value)} placeholder="100" style={IS}/>{toWinStr&&<div style={{background:"#0d0d14",border:"1px solid #1e1e2e",borderRadius:8,padding:"8px 12px",marginTop:8,display:"flex",justifyContent:"space-between",fontFamily:"'JetBrains Mono',monospace",fontSize:13}}><span style={{color:"#6b6b8a"}}>Free bet - Risk $0</span><span style={{color:"#22c55e",fontWeight:600}}>Win: {"$"+fmt(parseFloat(toWinStr)||0)}</span></div>}</div>):(<div><div style={{display:"flex",gap:8}}><div style={{flex:1}}><div style={{display:"flex",alignItems:"center",gap:5,marginBottom:3}}><input type="radio" id="r1" checked={riskMode==="risk"} onChange={()=>setRiskMode("risk")} style={{accentColor:"#22c55e"}}/><label htmlFor="r1" style={{fontSize:12,color:"#a0a0b8",fontWeight:500}}>Risk $</label></div><input value={stakeStr} onChange={e=>{setStakeStr(e.target.value);setRiskMode("risk");}} placeholder="0.00" style={{...IS,fontWeight:riskMode==="risk"?600:400}}/></div><div style={{flex:1}}><div style={{display:"flex",alignItems:"center",gap:5,marginBottom:3}}><input type="radio" id="r2" checked={riskMode==="towin"} onChange={()=>setRiskMode("towin")} style={{accentColor:"#22c55e"}}/><label htmlFor="r2" style={{fontSize:12,color:"#a0a0b8",fontWeight:500}}>To Win $</label></div><input value={toWinStr} onChange={e=>{setToWinStr(e.target.value);setRiskMode("towin");}} placeholder="0.00" style={{...IS,fontWeight:riskMode==="towin"?600:400}}/></div></div>{stakeStr&&toWinStr&&<div style={{background:"#0d0d14",border:"1px solid #1e1e2e",borderRadius:8,padding:"8px 12px",marginTop:8,display:"flex",justifyContent:"space-between",fontFamily:"'JetBrains Mono',monospace",fontSize:13}}><span style={{color:"#6b6b8a"}}>Payout</span><span style={{color:"#22c55e",fontWeight:600}}>{"$"+fmt((parseFloat(stakeStr)||0)+(parseFloat(toWinStr)||0))}</span></div>}</div>)}</div>)}
      </Sec>
      <Sec c="#6b6b8a" label="Tags & Notes">
        <div style={{display:"flex",flexWrap:"wrap",gap:5,marginBottom:8}}>{tags.map(t=><button key={t} onClick={()=>{const nxt=selTags.includes(t)?selTags.filter(x=>x!==t):[...selTags,t];setSelTags(nxt);if(t==="Freebet"&&!selTags.includes(t)&&!multiBook){setStakeStr("0");setRiskMode("risk");}}} style={{...BS,padding:"3px 10px",background:selTags.includes(t)?(t==="Freebet"?"#2e2a1a":"#1a2e1a"):"transparent",color:selTags.includes(t)?(t==="Freebet"?"#f59e0b":"#22c55e"):"#525280",border:"1px solid "+(selTags.includes(t)?(t==="Freebet"?"#f59e0b44":"#22c55e44"):"#1e1e2e")}}>{t}</button>)}</div>
        <textarea value={notes} onChange={e=>setNotes(e.target.value)} placeholder="Notes..." rows={2} style={{...IS,resize:"vertical"}}/>
      </Sec>
      <button onClick={handleSave} disabled={!canSave} style={{...BP,width:"100%",opacity:canSave?1:0.4,marginBottom:20}}>{isEdit?"Update":multiBook?"Save ("+((mT&&mT.count)||0)+" books)":"Save Bet"}</button>
      </>}
    </div>
  );
}
function Sec({c,label,children}){return(<div style={{background:"#111118",border:"1px solid #1e1e2e",borderRadius:10,padding:14,marginBottom:12}}>{label&&<div style={{fontSize:10,color:c||"#6b6b8a",fontWeight:600,marginBottom:10,textTransform:"uppercase",letterSpacing:1}}>{label}</div>}{children}</div>);}

// ---- SETTINGS ----
function SetP({settings,setSettings,books,setBooks,holders,setHolders,tags,setTags,bets,setBets}){
  const[newBook,setNewBook]=useState("");const[newHolder,setNewHolder]=useState("");const[newTag,setNewTag]=useState("");const[showDanger,setShowDanger]=useState(false);const[confirmDeleteAll,setConfirmDeleteAll]=useState(false);
  return(<div style={{paddingTop:20,maxWidth:600,margin:"0 auto"}}><h2 style={{margin:"0 0 20px",fontSize:18,fontWeight:600}}>Settings</h2>
    <SC t="Unit Size"><div style={{display:"flex",alignItems:"center",gap:8}}><span style={{color:"#6b6b8a"}}>$</span><input type="number" value={settings.unitSize} onChange={e=>setSettings(s=>({...s,unitSize:parseFloat(e.target.value)||100}))} style={{...IS,width:120}}/><span style={{fontSize:12,color:"#525280"}}>{"1u = $"+settings.unitSize}</span></div></SC>
    <SC t="Default Odds Format"><div style={{display:"flex",gap:8}}>{["american","decimal"].map(f=><button key={f} onClick={()=>setSettings(s=>({...s,oddsFormat:f}))} style={{...BS,background:settings.oddsFormat===f?"#1a2e1a":"#111118",color:settings.oddsFormat===f?"#22c55e":"#6b6b8a"}}>{f==="american"?"American":"Decimal"}</button>)}</div></SC>
    <LS t={"Sportsbooks ("+books.length+")"} items={books} set={setBooks} nv={newBook} snv={setNewBook} ph="Add sportsbook..."/>
    <LS t={"Accounts ("+holders.length+")"} items={holders} set={setHolders} nv={newHolder} snv={setNewHolder} ph="Add account..." min={1}/>
    <LS t={"Tags ("+tags.length+")"} items={tags} set={setTags} nv={newTag} snv={setNewTag} ph="Add tag..."/>
    <SC t="Data"><div style={{fontSize:13,color:"#a0a0b8",marginBottom:12}}>Total: <strong>{bets.length}</strong>{DOT}Settled: <strong>{bets.filter(b=>b.result).length}</strong>{DOT}Pending: <strong>{bets.filter(b=>!b.result).length}</strong></div><button onClick={()=>setShowDanger(!showDanger)} style={{...BS,color:"#ef4444"}}>{showDanger?"Hide":"Danger Zone"}</button>{showDanger&&<div style={{marginTop:10,padding:12,background:"#1a0a0a",borderRadius:8,border:"1px solid #3a1a1a"}}>{confirmDeleteAll?<div style={{display:"flex",gap:8}}><button onClick={()=>{setBets([]);setConfirmDeleteAll(false);}} style={{...BS,background:"#2a0a0a",color:"#ef4444",border:"1px solid #ef444444",flex:1,justifyContent:"center"}}>Confirm Delete All</button><button onClick={()=>setConfirmDeleteAll(false)} style={{...BS,flex:1,justifyContent:"center"}}>Cancel</button></div>:<button onClick={()=>setConfirmDeleteAll(true)} style={{...BS,background:"#2a0a0a",color:"#ef4444",border:"1px solid #ef444444",width:"100%"}}>Delete All Bets</button>}</div>}</SC>
  </div>);
}
function SC({t,children}){return(<div style={{background:"#111118",border:"1px solid #1e1e2e",borderRadius:10,padding:16,marginBottom:12}}><div style={{fontSize:13,fontWeight:600,color:"#a0a0b8",marginBottom:12}}>{t}</div>{children}</div>);}
function LS({t,items,set,nv,snv,ph,min=0}){return(<SC t={t}><div style={{display:"flex",flexWrap:"wrap",gap:6,marginBottom:10}}>{items.map(v=><div key={v} style={{display:"flex",alignItems:"center",gap:4,background:"#0d0d14",padding:"4px 10px",borderRadius:6,fontSize:12,color:"#a0a0b8"}}>{v}{items.length>min&&<button onClick={()=>set(p=>p.filter(x=>x!==v))} style={{background:"none",border:"none",color:"#525280",cursor:"pointer",padding:0,fontSize:14}}>{"Ã—"}</button>}</div>)}</div><div style={{display:"flex",gap:6}}><input value={nv} onChange={e=>snv(e.target.value)} placeholder={ph} style={{...IS,flex:1}} onKeyDown={e=>{if(e.key==="Enter"&&nv.trim()){set(p=>[...p,nv.trim()]);snv("");}}}/><button onClick={()=>{if(nv.trim()){set(p=>[...p,nv.trim()]);snv("");}}} style={BS}>Add</button></div></SC>);}
function Lb({children}){return(<div style={{fontSize:11,color:"#6b6b8a",fontWeight:500,marginBottom:4,textTransform:"uppercase",letterSpacing:"0.5px"}}>{children}</div>);}

const IS={background:"#0d0d14",border:"1px solid #1e1e2e",borderRadius:6,padding:"8px 10px",color:"#e0e0e0",fontSize:13,fontFamily:"'Inter',sans-serif",width:"100%",boxSizing:"border-box",outline:"none"};
const SS={...IS,cursor:"pointer",appearance:"auto"};
const BS={background:"#111118",border:"1px solid #1e1e2e",borderRadius:6,padding:"6px 12px",color:"#a0a0b8",fontSize:12,cursor:"pointer",fontWeight:500,display:"flex",alignItems:"center",gap:4,whiteSpace:"nowrap"};
const BP={background:"#166534",border:"1px solid #22c55e44",borderRadius:8,padding:"10px 20px",color:"#e0e0e0",fontSize:14,cursor:"pointer",fontWeight:600,textAlign:"center"};

// Mount
ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
